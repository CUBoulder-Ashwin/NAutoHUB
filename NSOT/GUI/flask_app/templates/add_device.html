{% extends "base.html" %}
{% block title %}Add Device - NAutoHUB{% endblock %}

{% block content %}
<div class="page-header">
  <h1 class="page-title">Add Device</h1>
  <p class="page-description">Add a new device to your existing network topology</p>
</div>

<div class="card card-elevated" style="max-width: 700px; margin: 0 auto;">
  <div class="card-body">
    <form method="POST" class="form" id="add-device-form" onsubmit="showLoading()">
      <div class="form-fieldset">
        <legend class="form-legend">Device Information</legend>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Device Name</label>
            <input type="text" name="device_name" class="form-input" required>
          </div>
          <div class="form-group">
            <label class="form-label">Kind</label>
            <select name="kind" id="kind-select" class="form-select" required onchange="toggleExecOrConfig()">
              <option value="">-- Select Kind --</option>
              <option value="ceos">ceos</option>
              <option value="linux">linux</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Docker Image</label>
          <select name="image" class="form-select" required>
            <option value="">-- Select Image --</option>
            {% for img in docker_images %}
              <option value="{{ img }}">{{ img }}</option>
            {% endfor %}
          </select>
        </div>

        <div id="config-section" class="form-group" style="display: none;">
          <label class="form-label">Config File Path</label>
          <input type="text" name="config" class="form-input" placeholder="/path/to/config.cfg">
        </div>

        <div id="exec-section" class="form-group" style="display: none;">
          <label class="form-label">Exec Commands (1 per line)</label>
          <textarea name="exec[]" rows="4" class="form-textarea" placeholder="ip link set eth1 up&#10;dhclient eth1"></textarea>
        </div>

        <div class="form-group">
          <label class="form-label">MAC Address (optional)</label>
          <input type="text" name="mac_address" class="form-input">
        </div>
      </div>

      <div class="form-fieldset">
        <legend class="form-legend">Network Configuration</legend>

        <div class="form-group">
          <label class="form-label">Management IP Address (with subnet)</label>
          <input type="text" name="ip_address" class="form-input" placeholder="10.0.0.1/24" required>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">SSH Username</label>
            <input type="text" name="username" class="form-input" placeholder="admin" required>
          </div>
          <div class="form-group">
            <label class="form-label">SSH Password</label>
            <input type="password" name="password" class="form-input" placeholder="admin" required>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">How many devices to connect to</label>
          <input type="number" name="connection_count" id="connection-count" class="form-input" min="0" max="10" value="0" style="max-width: 150px;">
        </div>

        <div id="connection-dropdowns"></div>
      </div>

      {% if message %}
      <div class="alert alert-success">
        <span class="alert-icon">&#10003;</span>
        <div class="alert-content">{{ message|safe }}</div>
      </div>
      {% endif %}

      <div class="form-actions form-actions-center">
        <button type="submit" class="btn btn-primary">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="5" x2="12" y2="19"/>
            <line x1="5" y1="12" x2="19" y2="12"/>
          </svg>
          Add Device
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Loading Overlay -->
<div class="modal-overlay" id="loading-overlay" style="display: none;">
  <div class="loading-container">
    <div class="loading-spinner"></div>
    <p class="loading-text" id="loading-text">Initializing...</p>
  </div>
</div>

<style>
/* Loading overlay specific styles */
.loading-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: var(--space-4);
}

.loading-spinner {
  width: 48px;
  height: 48px;
  border: 4px solid var(--color-border);
  border-top-color: var(--color-primary);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.loading-text {
  color: var(--color-text-primary);
  font-size: var(--font-size-sm);
  font-weight: var(--font-weight-medium);
  transition: opacity 0.5s ease-in-out;
}
</style>

<script>
function toggleExecOrConfig() {
  const kind = document.getElementById("kind-select").value;
  document.getElementById("config-section").style.display = kind === "ceos" ? "block" : "none";
  document.getElementById("exec-section").style.display = kind === "linux" ? "block" : "none";
}

function renderConnectionDropdowns() {
  const count = parseInt(document.getElementById("connection-count").value);
  const container = document.getElementById("connection-dropdowns");
  container.innerHTML = "";

  for (let i = 0; i < count; i++) {
    const div = document.createElement("div");
    div.classList.add("form-group");
    div.innerHTML = `
      <label class="form-label">Connect to Device ${i + 1}</label>
      <select name="connect_to_${i}" class="form-select" required>
        <option value="">-- Select Device --</option>
        {% for host in available_hosts %}
          <option value="{{ host }}">{{ host }}</option>
        {% endfor %}
      </select>
    `;
    container.appendChild(div);
  }
}

function showLoading() {
  document.getElementById("loading-overlay").style.display = "flex";
  rotateTerms();
}

document.addEventListener("DOMContentLoaded", function () {
  toggleExecOrConfig();
  document.getElementById("connection-count").addEventListener("input", renderConnectionDropdowns);
});

const terms = [
  "Routing BGP packets to Valhalla...",
  "Spinning up Layer 3 magic...",
  "Injecting routes into the Matrix...",
  "Summoning OSPF daemons...",
  "Crafting VLAN potions...",
  "Talking to network oracles...",
  "Negotiating with DHCP spirits...",
  "Sniffing packets from the astral plane...",
  "Tunneling through hyperspace...",
  "Enabling port-channel wizardry...",
  "Building bridges with STP spells...",
  "Balancing traffic on the tightrope of ECMP...",
  "Fragmenting datagrams with care...",
  "Conjuring MAC addresses...",
  "Programming the P4 gods...",
  "Pinging the void...",
  "Announcing routes like a prophet...",
  "Weaving MPLS labels into destiny...",
  "Encoding bits of truth...",
  "Assembling TCP handshakes...",
  "Peering with interdimensional routers...",
  "Binding interfaces with eldritch configs...",
  "Casting 'show run' scrolls...",
  "Parsing YANGs of destiny...",
  "Bridging subnets across galaxies...",
  "Extracting SNMP secrets from the vault...",
  "Interfacing with quantum NICs...",
  "Configuring routers with dark magic...",
  "Recabling cables with thoughts alone...",
  "Blessing interfaces with zero drops...",
  "Summoning Ceos spirits from the cloud...",
  "Resurrecting containers from the abyss...",
  "Defragmenting reality into packets...",
  "Rebooting layer zero...",
  "Beaming bits through wormholes...",
  "Unrolling IPv6 prophecies...",
  "Hacking the mainframe of the underlay...",
  "Teleporting configs into flash...",
];

// Shuffle once to avoid repetition in each session
terms.sort(() => Math.random() - 0.5);

let index = 0;
let rotateInterval;

function rotateTerms() {
  const el = document.getElementById("loading-text");
  el.style.opacity = 0;
  setTimeout(() => {
    el.innerText = terms[index];
    el.style.opacity = 1;
    index = (index + 1) % terms.length;
  }, 500);

  if (!rotateInterval) {
    rotateInterval = setInterval(rotateTerms, 7000);
  }
}
</script>
{% endblock %}
