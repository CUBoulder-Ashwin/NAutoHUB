{% extends "base.html" %}
{% block title %}Configure Device - NAutoHUB{% endblock %}

{% block content %}
<div class="page-header">
  <h1 class="page-title">Configure Device</h1>
  <p class="page-description">Select protocols and features to configure your network device</p>
</div>

<div class="card card-elevated" style="max-width: 1200px; margin: 0 auto;">
  <div class="card-body">
    <form method="POST" class="form" id="config-form" onsubmit="return showLoading()">
      <!-- Device Selection -->
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Device Name</label>
          <select name="device_id" class="form-select" required>
            <option value="" disabled selected>Select Device</option>
            {% for device in devices %}
            <option value="{{ device }}">{{ device }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Device Vendor</label>
          <select name="device_vendor" class="form-select" required>
            <option value="">Select Vendor</option>
            <option value="arista">Arista</option>
            <option value="cisco">Cisco</option>
            <option value="juniper">Juniper</option>
          </select>
        </div>
      </div>

      <!-- Config File Upload Section -->
      <div class="section-header" style="margin-top: var(--space-8);">
        <span class="section-title">Quick Configuration Upload</span>
        <div class="section-line"></div>
      </div>

      <div class="config-upload-container">
        <div class="upload-mode-toggle">
          <button type="button" class="mode-btn active" data-mode="manual" onclick="toggleConfigMode('manual')">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="3"/>
              <path d="M12 1v6m0 6v6m9-9h-6m-6 0H3"/>
            </svg>
            Manual Configuration
          </button>
          <button type="button" class="mode-btn" data-mode="upload" onclick="toggleConfigMode('upload')">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
              <polyline points="17 8 12 3 7 8"/>
              <line x1="12" y1="3" x2="12" y2="15"/>
            </svg>
            Upload Config File
          </button>
        </div>

        <div id="upload-section" class="upload-section" style="display: none;">
          <div class="file-upload-area" id="dropZone">
            <div class="upload-icon">
              <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="17 8 12 3 7 8"/>
                <line x1="12" y1="3" x2="12" y2="15"/>
              </svg>
            </div>
            <h3 class="upload-title">Drag & Drop Config File</h3>
            <p class="upload-description">or click to browse</p>
            <p class="upload-hint">Supports .cfg, .txt, .conf files</p>
            <input type="file" id="configFileInput" accept=".cfg,.txt,.conf" style="display: none;">
          </div>

          <div id="filePreview" class="file-preview" style="display: none;">
            <div class="file-preview-header">
              <div class="file-info">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/>
                  <polyline points="13 2 13 9 20 9"/>
                </svg>
                <div>
                  <div class="file-name" id="fileName"></div>
                  <div class="file-size" id="fileSize"></div>
                </div>
              </div>
              <button type="button" class="btn-icon btn-sm" onclick="clearFile()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"/>
                  <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
              </button>
            </div>
            <div class="file-preview-content">
              <pre id="fileContent"></pre>
            </div>
          </div>

          <div class="form-actions" style="border: none; padding-top: var(--space-4);">
            <button type="button" class="btn btn-primary" onclick="uploadConfigFile()" id="uploadBtn" disabled>
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 2L11 13"/>
                <path d="M22 2L15 22 11 13 2 9 22 2z"/>
              </svg>
              Push Configuration to Device
            </button>
          </div>
        </div>
      </div>

      <!-- Protocol Organization by Layer -->
      <div class="section-header" style="margin-top: var(--space-8);">
        <span class="section-title">Layer 2 Protocols</span>
        <div class="section-line"></div>
      </div>

      <div class="protocol-grid">
        <!-- VLAN Bubble -->
        <div class="protocol-bubble" data-protocol="vlan" onclick="toggleProtocol('vlan')">
          <div class="protocol-bubble-icon">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="7" height="7" rx="1"/>
              <rect x="14" y="3" width="7" height="7" rx="1"/>
              <rect x="3" y="14" width="7" height="7" rx="1"/>
              <rect x="14" y="14" width="7" height="7" rx="1"/>
            </svg>
          </div>
          <div class="protocol-bubble-title">VLAN</div>
          <div class="protocol-bubble-badge">0</div>
        </div>

        <!-- STP Bubble -->
        <div class="protocol-bubble" data-protocol="stp" onclick="toggleProtocol('stp')">
          <div class="protocol-bubble-icon">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="5" r="3"/>
              <line x1="12" y1="8" x2="12" y2="12"/>
              <line x1="12" y1="12" x2="6" y2="19"/>
              <line x1="12" y1="12" x2="18" y2="19"/>
              <circle cx="6" cy="19" r="2"/>
              <circle cx="18" cy="19" r="2"/>
            </svg>
          </div>
          <div class="protocol-bubble-title">STP</div>
          <div class="protocol-bubble-badge">0</div>
        </div>

        <!-- VXLAN Bubble -->
        <div class="protocol-bubble" data-protocol="vxlan" onclick="toggleProtocol('vxlan')">
          <div class="protocol-bubble-icon">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7"/>
              <ellipse cx="12" cy="7" rx="8" ry="4"/>
              <path d="M4 12c0 2.21 3.582 4 8 4s8-1.79 8-4"/>
            </svg>
          </div>
          <div class="protocol-bubble-title">VXLAN</div>
          <div class="protocol-bubble-badge">0</div>
        </div>
      </div>

      <div class="section-header" style="margin-top: var(--space-8);">
        <span class="section-title">Layer 3 Protocols</span>
        <div class="section-line"></div>
      </div>

      <div class="protocol-grid">
        <!-- Interfaces Bubble -->
        <div class="protocol-bubble" data-protocol="interfaces" onclick="toggleProtocol('interfaces')">
          <div class="protocol-bubble-icon">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="2" y="7" width="20" height="10" rx="2"/>
              <line x1="6" y1="11" x2="6" y2="13"/>
              <line x1="10" y1="11" x2="10" y2="13"/>
              <line x1="14" y1="11" x2="14" y2="13"/>
              <line x1="18" y1="11" x2="18" y2="13"/>
            </svg>
          </div>
          <div class="protocol-bubble-title">Interfaces</div>
          <div class="protocol-bubble-badge">0</div>
        </div>

        <!-- Subinterfaces Bubble -->
        <div class="protocol-bubble" data-protocol="subinterfaces" onclick="toggleProtocol('subinterfaces')">
          <div class="protocol-bubble-icon">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 2v6m0 0L9 5m3 3l3-3"/>
              <path d="M19 10v4a7 7 0 01-14 0v-4"/>
            </svg>
          </div>
          <div class="protocol-bubble-title">Subinterfaces</div>
          <div class="protocol-bubble-badge">0</div>
        </div>

        <!-- Static Routes Bubble -->
        <div class="protocol-bubble" data-protocol="static" onclick="toggleProtocol('static')">
          <div class="protocol-bubble-icon">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="5" y1="12" x2="19" y2="12"/>
              <polyline points="12 5 19 12 12 19"/>
            </svg>
          </div>
          <div class="protocol-bubble-title">Static Routes</div>
          <div class="protocol-bubble-badge">0</div>
        </div>

        <!-- BGP Bubble -->
        <div class="protocol-bubble" data-protocol="bgp" onclick="toggleProtocol('bgp')">
          <div class="protocol-bubble-icon">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="3"/>
              <path d="M12 1v6m0 6v6M23 12h-6m-6 0H5"/>
              <circle cx="12" cy="12" r="10"/>
            </svg>
          </div>
          <div class="protocol-bubble-title">BGP</div>
          <div class="protocol-bubble-badge">0</div>
        </div>

        <!-- OSPF Bubble -->
        <div class="protocol-bubble" data-protocol="ospf" onclick="toggleProtocol('ospf')">
          <div class="protocol-bubble-icon">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polygon points="12 2 2 7 12 12 22 7 12 2"/>
              <polyline points="2 17 12 22 22 17"/>
              <polyline points="2 12 12 17 22 12"/>
            </svg>
          </div>
          <div class="protocol-bubble-title">OSPF</div>
          <div class="protocol-bubble-badge">0</div>
        </div>

        <!-- EIGRP Bubble -->
        <div class="protocol-bubble" data-protocol="eigrp" onclick="toggleProtocol('eigrp')">
          <div class="protocol-bubble-icon">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/>
              <polyline points="3.27 6.96 12 12.01 20.73 6.96"/>
              <line x1="12" y1="22.08" x2="12" y2="12"/>
            </svg>
          </div>
          <div class="protocol-bubble-title">EIGRP</div>
          <div class="protocol-bubble-badge">0</div>
        </div>

        <!-- RIP Bubble -->
        <div class="protocol-bubble" data-protocol="rip" onclick="toggleProtocol('rip')">
          <div class="protocol-bubble-icon">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <line x1="12" y1="8" x2="12" y2="16"/>
              <line x1="8" y1="12" x2="16" y2="12"/>
            </svg>
          </div>
          <div class="protocol-bubble-title">RIP</div>
          <div class="protocol-bubble-badge">0</div>
        </div>

        <!-- IS-IS Bubble -->
        <div class="protocol-bubble" data-protocol="isis" onclick="toggleProtocol('isis')">
          <div class="protocol-bubble-icon">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 2L2 7l10 5 10-5-10-5z"/>
              <path d="M2 17l10 5 10-5M2 12l10 5 10-5"/>
            </svg>
          </div>
          <div class="protocol-bubble-title">IS-IS</div>
          <div class="protocol-bubble-badge">0</div>
        </div>

        <!-- MPLS Bubble -->
        <div class="protocol-bubble" data-protocol="mpls" onclick="toggleProtocol('mpls')">
          <div class="protocol-bubble-icon">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 12h18M3 6h18M3 18h18"/>
              <circle cx="7" cy="12" r="2"/>
              <circle cx="17" cy="12" r="2"/>
            </svg>
          </div>
          <div class="protocol-bubble-title">MPLS</div>
          <div class="protocol-bubble-badge">0</div>
        </div>
      </div>

      <!-- Expandable Protocol Sections -->
      <div id="protocol-sections" style="margin-top: var(--space-8);"></div>

      {% if message %}
      <div class="alert alert-success">
        <span class="alert-icon">&#10003;</span>
        <div class="alert-content">{{ message }}</div>
      </div>
      {% endif %}

      <div id="push-message"></div>

      <div class="form-actions form-actions-center">
        <button type="submit" class="btn btn-primary">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="3"/>
            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
          </svg>
          Generate Configuration
        </button>
      </div>
    </form>

    {% if jenkins_result == 'jenkins_success' %}
    <div class="form-actions form-actions-center" id="push-button-wrapper" style="margin-top: var(--space-4); border: none;">
      <button type="button" class="btn btn-primary" onclick="pushConfig()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M22 2L11 13"/>
          <path d="M22 2L15 22 11 13 2 9 22 2z"/>
        </svg>
        Push Configuration
      </button>
    </div>
    {% endif %}
  </div>
</div>

<!-- Loading Overlay -->
<div class="modal-overlay" id="loading-overlay" style="display: none;">
  <div class="loading-container">
    <div class="loading-spinner"></div>
    <p class="loading-text" id="loading-text">Initializing...</p>
  </div>
</div>

<style>
/* Protocol Bubbles Grid */
.protocol-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
  gap: var(--space-4);
  margin-bottom: var(--space-6);
}

/* Protocol Bubble */
.protocol-bubble {
  position: relative;
  background: linear-gradient(135deg, var(--color-surface) 0%, var(--color-bg-secondary) 100%);
  border: 2px solid var(--color-border);
  border-radius: var(--radius-xl);
  padding: var(--space-5);
  text-align: center;
  cursor: pointer;
  transition: all var(--transition-base);
  overflow: hidden;
}

.protocol-bubble::before {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, var(--color-primary), var(--color-accent));
  transform: scaleX(0);
  transition: transform var(--transition-base);
}

.protocol-bubble:hover {
  border-color: var(--color-primary);
  transform: translateY(-4px) scale(1.02);
  box-shadow: var(--shadow-lg);
}

.protocol-bubble:hover::before {
  transform: scaleX(1);
}

.protocol-bubble.active {
  border-color: var(--color-primary);
  background: linear-gradient(135deg, var(--color-primary-light) 0%, var(--color-surface) 100%);
  box-shadow: var(--shadow-md), 0 0 0 2px var(--color-primary);
}

.protocol-bubble.active::before {
  transform: scaleX(1);
}

.protocol-bubble-icon {
  margin-bottom: var(--space-3);
  color: var(--color-primary);
  display: flex;
  align-items: center;
  justify-content: center;
  transition: transform var(--transition-base);
}

.protocol-bubble:hover .protocol-bubble-icon {
  transform: scale(1.1);
}

.protocol-bubble.active .protocol-bubble-icon {
  color: var(--color-primary);
}

.protocol-bubble-title {
  font-size: var(--font-size-sm);
  font-weight: var(--font-weight-semibold);
  color: var(--color-text-primary);
  margin-bottom: var(--space-2);
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.protocol-bubble-badge {
  position: absolute;
  top: var(--space-2);
  right: var(--space-2);
  background: linear-gradient(135deg, var(--color-primary), var(--color-accent));
  color: white;
  width: 24px;
  height: 24px;
  border-radius: var(--radius-full);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: var(--font-size-xs);
  font-weight: var(--font-weight-bold);
  box-shadow: var(--shadow-sm);
  opacity: 0;
  transform: scale(0);
  transition: all var(--transition-base);
}

.protocol-bubble.active .protocol-bubble-badge,
.protocol-bubble.has-config .protocol-bubble-badge {
  opacity: 1;
  transform: scale(1);
}

/* Protocol Section (Expandable) */
.protocol-section {
  background: linear-gradient(135deg, var(--color-surface) 0%, var(--color-bg-secondary) 100%);
  border: 1px solid var(--color-border);
  border-left: 4px solid var(--color-primary);
  border-radius: var(--radius-lg);
  padding: var(--space-6);
  margin-bottom: var(--space-5);
  animation: expandIn 0.3s ease-out;
}

.protocol-section-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: var(--space-5);
  padding-bottom: var(--space-4);
  border-bottom: 2px solid transparent;
  border-image: linear-gradient(90deg, var(--color-primary), transparent) 1;
}

.protocol-section-title {
  font-family: var(--font-family-display);
  font-size: var(--font-size-lg);
  font-weight: var(--font-weight-semibold);
  color: var(--color-text-primary);
  text-transform: uppercase;
  letter-spacing: 0.05em;
  background: linear-gradient(90deg, var(--color-primary), var(--color-accent));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.protocol-section-close {
  background: transparent;
  border: none;
  color: var(--color-text-muted);
  cursor: pointer;
  padding: var(--space-2);
  border-radius: var(--radius-md);
  transition: all var(--transition-fast);
}

.protocol-section-close:hover {
  background: var(--color-error-light);
  color: var(--color-error);
}

@keyframes expandIn {
  from {
    opacity: 0;
    transform: translateY(-20px) scale(0.95);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

/* Loading styles */
.loading-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: var(--space-4);
}

.loading-spinner {
  width: 48px;
  height: 48px;
  border: 4px solid var(--color-border);
  border-top-color: var(--color-primary);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.loading-text {
  color: var(--color-text-primary);
  font-size: var(--font-size-sm);
  font-weight: var(--font-weight-medium);
  transition: opacity 0.5s ease-in-out;
}

/* Config block styling */
.config-block {
  background: linear-gradient(135deg, var(--color-bg-secondary) 0%, var(--color-surface) 100%);
  border-radius: var(--radius-lg);
  padding: var(--space-5);
  margin-bottom: var(--space-4);
  border: 1px solid var(--color-border);
  position: relative;
  transition: all var(--transition-base);
  animation: slideIn 0.3s ease-out;
}

.config-block::before {
  content: "";
  position: absolute;
  left: 0;
  top: 0;
  bottom: 0;
  width: 4px;
  background: linear-gradient(180deg, var(--color-primary), var(--color-accent));
  border-radius: var(--radius-lg) 0 0 var(--radius-lg);
  opacity: 0.7;
}

.config-block:hover {
  border-color: var(--color-primary);
  box-shadow: var(--shadow-md);
  transform: translateX(4px);
}

.config-block:hover::before {
  opacity: 1;
}

.config-block .form-row {
  margin-bottom: var(--space-4);
}

.config-block .form-row:last-child {
  margin-bottom: 0;
}

.config-block .btn-danger {
  margin-top: var(--space-3);
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Checkbox group styling */
.checkbox-group {
  display: flex;
  flex-wrap: wrap;
  gap: var(--space-4);
  margin: var(--space-4) 0;
  padding: var(--space-4);
  background: var(--color-bg-secondary);
  border-radius: var(--radius-md);
  border: 1px solid var(--color-border);
}

.checkbox-group .form-check {
  padding: var(--space-2) var(--space-3);
  background: var(--color-surface);
  border-radius: var(--radius-sm);
  border: 1px solid transparent;
  transition: all var(--transition-fast);
}

.checkbox-group .form-check:hover {
  border-color: var(--color-primary);
  box-shadow: var(--shadow-sm);
}

/* Upload mode toggle */
.upload-mode-toggle {
  display: flex;
  gap: var(--space-3);
  margin-bottom: var(--space-6);
  background: var(--color-bg-secondary);
  padding: var(--space-2);
  border-radius: var(--radius-lg);
  border: 1px solid var(--color-border);
}

.mode-btn {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: var(--space-2);
  padding: var(--space-3) var(--space-5);
  background: transparent;
  border: 1px solid transparent;
  border-radius: var(--radius-md);
  color: var(--color-text-secondary);
  font-size: var(--font-size-sm);
  font-weight: var(--font-weight-medium);
  cursor: pointer;
  transition: all var(--transition-fast);
}

.mode-btn:hover {
  background: var(--color-surface);
  color: var(--color-text-primary);
}

.mode-btn.active {
  background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-hover) 100%);
  color: var(--color-text-inverse);
  border-color: var(--color-primary);
  box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
}

/* File upload area */
.file-upload-area {
  border: 2px dashed var(--color-border);
  border-radius: var(--radius-lg);
  padding: var(--space-10);
  text-align: center;
  cursor: pointer;
  transition: all var(--transition-base);
  background: linear-gradient(135deg, var(--color-surface) 0%, var(--color-bg-secondary) 100%);
}

.file-upload-area:hover {
  border-color: var(--color-primary);
  background: linear-gradient(135deg, var(--color-bg-secondary) 0%, var(--color-surface) 100%);
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

.file-upload-area.drag-over {
  border-color: var(--color-primary);
  background: var(--color-primary-light);
  box-shadow: 0 0 0 4px var(--color-primary-light);
}

.upload-icon {
  color: var(--color-primary);
  margin-bottom: var(--space-4);
  opacity: 0.7;
  transition: all var(--transition-base);
}

.file-upload-area:hover .upload-icon {
  opacity: 1;
  transform: translateY(-4px);
}

.upload-title {
  font-size: var(--font-size-lg);
  font-weight: var(--font-weight-semibold);
  color: var(--color-text-primary);
  margin-bottom: var(--space-2);
}

.upload-description {
  color: var(--color-text-secondary);
  font-size: var(--font-size-sm);
  margin-bottom: var(--space-1);
}

.upload-hint {
  color: var(--color-text-tertiary);
  font-size: var(--font-size-xs);
}

/* File preview */
.file-preview {
  margin-top: var(--space-6);
  background: linear-gradient(135deg, var(--color-surface) 0%, var(--color-bg-secondary) 100%);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-lg);
  overflow: hidden;
  animation: slideIn 0.3s ease-out;
}

.file-preview-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: var(--space-4);
  border-bottom: 1px solid var(--color-border);
  background: var(--color-bg-secondary);
}

.file-info {
  display: flex;
  align-items: center;
  gap: var(--space-3);
  color: var(--color-primary);
}

.file-name {
  font-weight: var(--font-weight-semibold);
  color: var(--color-text-primary);
  font-size: var(--font-size-sm);
}

.file-size {
  font-size: var(--font-size-xs);
  color: var(--color-text-tertiary);
  margin-top: var(--space-1);
}

.file-preview-content {
  max-height: 400px;
  overflow-y: auto;
  padding: var(--space-4);
}

.file-preview-content pre {
  margin: 0;
  font-family: var(--font-family-mono);
  font-size: var(--font-size-xs);
  color: var(--color-text-primary);
  background: var(--color-bg-tertiary);
  padding: var(--space-4);
  border-radius: var(--radius-md);
  border-left: 4px solid var(--color-primary);
  white-space: pre-wrap;
  word-break: break-word;
}

.upload-section {
  animation: fadeIn 0.3s ease-out;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
</style>

<script>
// Config upload state
let uploadedFile = null;
let currentMode = 'manual';

// Toggle between manual config and file upload
function toggleConfigMode(mode) {
  currentMode = mode;
  const manualBtn = document.querySelector('[data-mode="manual"]');
  const uploadBtn = document.querySelector('[data-mode="upload"]');
  const uploadSection = document.getElementById('upload-section');
  const protocolSections = document.querySelectorAll('.section-header, .protocol-grid, #protocol-sections');

  if (mode === 'upload') {
    manualBtn.classList.remove('active');
    uploadBtn.classList.add('active');
    uploadSection.style.display = 'block';
    protocolSections.forEach(el => el.style.display = 'none');
  } else {
    uploadBtn.classList.remove('active');
    manualBtn.classList.add('active');
    uploadSection.style.display = 'none';
    protocolSections.forEach(el => el.style.display = '');
  }
}

// Drag and drop handlers
const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('configFileInput');

dropZone.addEventListener('click', () => fileInput.click());

dropZone.addEventListener('dragover', (e) => {
  e.preventDefault();
  dropZone.classList.add('drag-over');
});

dropZone.addEventListener('dragleave', () => {
  dropZone.classList.remove('drag-over');
});

dropZone.addEventListener('drop', (e) => {
  e.preventDefault();
  dropZone.classList.remove('drag-over');

  const files = e.dataTransfer.files;
  if (files.length > 0) {
    handleFile(files[0]);
  }
});

fileInput.addEventListener('change', (e) => {
  if (e.target.files.length > 0) {
    handleFile(e.target.files[0]);
  }
});

function handleFile(file) {
  // Validate file type
  const validExtensions = ['.cfg', '.txt', '.conf'];
  const fileName = file.name.toLowerCase();
  const isValid = validExtensions.some(ext => fileName.endsWith(ext));

  if (!isValid) {
    alert('Please upload a valid config file (.cfg, .txt, .conf)');
    return;
  }

  uploadedFile = file;

  // Read file content
  const reader = new FileReader();
  reader.onload = (e) => {
    const content = e.target.result;
    displayFilePreview(file.name, file.size, content);
  };
  reader.readAsText(file);
}

function displayFilePreview(name, size, content) {
  document.getElementById('fileName').textContent = name;
  document.getElementById('fileSize').textContent = formatFileSize(size);
  document.getElementById('fileContent').textContent = content;
  document.getElementById('filePreview').style.display = 'block';
  document.getElementById('uploadBtn').disabled = false;

  // Hide drop zone
  dropZone.style.display = 'none';
}

function clearFile() {
  uploadedFile = null;
  document.getElementById('filePreview').style.display = 'none';
  document.getElementById('uploadBtn').disabled = true;
  dropZone.style.display = 'block';
  fileInput.value = '';
}

function formatFileSize(bytes) {
  if (bytes === 0) return '0 Bytes';
  const k = 1024;
  const sizes = ['Bytes', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

async function uploadConfigFile() {
  const deviceId = document.querySelector('select[name="device_id"]').value;
  const deviceVendor = document.querySelector('select[name="device_vendor"]').value;

  if (!deviceId || !deviceVendor) {
    alert('Please select both device name and vendor');
    return;
  }

  if (!uploadedFile) {
    alert('Please select a config file');
    return;
  }

  // Show loading
  showLoading();

  // Create form data
  const formData = new FormData();
  formData.append('config_file', uploadedFile);
  formData.append('device_id', deviceId);
  formData.append('device_vendor', deviceVendor);

  try {
    const response = await fetch('/upload-config', {
      method: 'POST',
      body: formData
    });

    const data = await response.json();

    // Hide loading
    document.getElementById('loading-overlay').style.display = 'none';

    if (data.status === 'success') {
      // Show success message
      const messageDiv = document.createElement('div');
      messageDiv.className = 'alert alert-success';
      messageDiv.innerHTML = `
        <span class="alert-icon">&#10003;</span>
        <div class="alert-content">${data.message}</div>
      `;
      document.querySelector('.card-body').insertBefore(messageDiv, document.querySelector('.card-body').firstChild);

      // Clear the file
      clearFile();
    } else {
      // Show error message
      const messageDiv = document.createElement('div');
      messageDiv.className = 'alert alert-error';
      messageDiv.innerHTML = `
        <span class="alert-icon">&#10005;</span>
        <div class="alert-content">${data.message}</div>
      `;
      document.querySelector('.card-body').insertBefore(messageDiv, document.querySelector('.card-body').firstChild);
    }
  } catch (error) {
    document.getElementById('loading-overlay').style.display = 'none';
    alert('Error uploading config: ' + error.message);
  }
}

// Active protocols state
const activeProtocols = new Set();
const protocolCounts = {};

// Protocol configurations - will be populated dynamically later with Jinja
const protocolConfigs = {
  interfaces: {
    title: 'Interface Configuration',
    fields: () => getInterfaceBlock()
  },
  subinterfaces: {
    title: 'Subinterface Configuration',
    fields: () => getSubinterfaceBlock()
  },
  vlan: {
    title: 'VLAN Configuration',
    fields: () => getVlanBlock()
  },
  bgp: {
    title: 'BGP Configuration',
    fields: () => getBgpSection()
  },
  ospf: {
    title: 'OSPF Configuration',
    fields: () => getOspfSection()
  },
  eigrp: {
    title: 'EIGRP Configuration',
    fields: () => getEigrpBlock()
  },
  rip: {
    title: 'RIP Configuration',
    fields: () => getRipBlock()
  },
  isis: {
    title: 'IS-IS Configuration',
    fields: () => getIsisBlock()
  },
  stp: {
    title: 'STP Configuration',
    fields: () => getStpBlock()
  },
  vxlan: {
    title: 'VXLAN Configuration',
    fields: () => getVxlanBlock()
  },
  mpls: {
    title: 'MPLS Configuration',
    fields: () => getMplsBlock()
  },
  static: {
    title: 'Static Routes Configuration',
    fields: () => getStaticRouteBlock()
  }
};

function toggleProtocol(protocol) {
  const bubble = document.querySelector(`[data-protocol="${protocol}"]`);
  const container = document.getElementById('protocol-sections');

  if (activeProtocols.has(protocol)) {
    // Remove protocol
    activeProtocols.delete(protocol);
    bubble.classList.remove('active');
    const section = document.getElementById(`section-${protocol}`);
    if (section) {
      section.remove();
    }

    // Recalculate count based on actual remaining config blocks
    const remainingBlocks = document.querySelectorAll(`#${protocol}-content .config-block`).length;
    protocolCounts[protocol] = remainingBlocks;
    updateBadge(protocol);
  } else {
    // Add protocol
    activeProtocols.add(protocol);
    bubble.classList.add('active');

    // Create section
    const section = document.createElement('div');
    section.id = `section-${protocol}`;
    section.className = 'protocol-section';
    section.innerHTML = `
      <div class="protocol-section-header">
        <h3 class="protocol-section-title">${protocolConfigs[protocol].title}</h3>
        <button type="button" class="protocol-section-close" onclick="toggleProtocol('${protocol}')">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>
      <div id="${protocol}-content"></div>
      <div class="form-actions form-actions-center" style="border: none; padding: 0; margin-top: var(--space-4);">
        <button type="button" class="btn btn-secondary btn-sm" onclick="addProtocolConfig('${protocol}')">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="5" x2="12" y2="19"/>
            <line x1="5" y1="12" x2="19" y2="12"/>
          </svg>
          Add Configuration
        </button>
      </div>
    `;
    container.appendChild(section);

    // Initialize count
    if (!protocolCounts[protocol]) {
      protocolCounts[protocol] = 0;
    }
    updateBadge(protocol);
  }
}

function addProtocolConfig(protocol) {
  const content = document.getElementById(`${protocol}-content`);
  content.insertAdjacentHTML('beforeend', protocolConfigs[protocol].fields());

  // Update count
  protocolCounts[protocol] = (protocolCounts[protocol] || 0) + 1;
  updateBadge(protocol);
}

function removeProtocolConfig(element, protocol) {
  element.closest('.config-block').remove();
  protocolCounts[protocol]--;
  updateBadge(protocol);
}

function updateBadge(protocol) {
  const bubble = document.querySelector(`[data-protocol="${protocol}"]`);
  const badge = bubble.querySelector('.protocol-bubble-badge');
  badge.textContent = protocolCounts[protocol];

  if (protocolCounts[protocol] > 0) {
    bubble.classList.add('has-config');
  } else {
    bubble.classList.remove('has-config');
  }
}

// Configuration block generators
function getInterfaceBlock() {
  return `
    <div class="config-block">
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Interface Type</label>
          <input type="text" name="interface_type[]" class="form-input" placeholder="Ethernet">
        </div>
        <div class="form-group">
          <label class="form-label">Interface Number</label>
          <input type="text" name="interface_number[]" class="form-input" placeholder="1">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">IP Address</label>
          <input type="text" name="interface_ip[]" class="form-input" placeholder="10.0.0.1">
        </div>
        <div class="form-group">
          <label class="form-label">Subnet Mask</label>
          <input type="text" name="interface_mask[]" class="form-input" placeholder="255.255.255.0">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group" style="max-width: 200px;">
          <label class="form-label">Switchport</label>
          <select name="switchport[]" class="form-select">
            <option value="no">No</option>
            <option value="yes">Yes</option>
          </select>
        </div>
      </div>
      <button type="button" class="btn btn-danger btn-sm" onclick="removeProtocolConfig(this, 'interfaces')">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
        Remove
      </button>
    </div>
  `;
}

function getSubinterfaceBlock() {
  return `
    <div class="config-block">
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Parent Interface</label>
          <input type="text" name="subinterface_parent[]" class="form-input" placeholder="Ethernet1">
        </div>
        <div class="form-group">
          <label class="form-label">Subinterface ID</label>
          <input type="text" name="subinterface_id[]" class="form-input" placeholder="100">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Encapsulation VLAN</label>
          <input type="text" name="subinterface_vlan[]" class="form-input" placeholder="100">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">IP Address</label>
          <input type="text" name="subinterface_ip[]" class="form-input" placeholder="10.0.1.1">
        </div>
        <div class="form-group">
          <label class="form-label">Subnet Mask</label>
          <input type="text" name="subinterface_mask[]" class="form-input" placeholder="255.255.255.0">
        </div>
      </div>
      <button type="button" class="btn btn-danger btn-sm" onclick="removeProtocolConfig(this, 'subinterfaces')">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
        Remove
      </button>
    </div>
  `;
}

function getVlanBlock() {
  return `
    <div class="config-block">
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">VLAN ID</label>
          <input type="text" name="vlan_id[]" class="form-input" placeholder="100">
        </div>
        <div class="form-group">
          <label class="form-label">VLAN Name</label>
          <input type="text" name="vlan_name[]" class="form-input" placeholder="Management">
        </div>
      </div>
      <button type="button" class="btn btn-danger btn-sm" onclick="removeProtocolConfig(this, 'vlan')">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
        Remove
      </button>
    </div>
  `;
}

function getBgpSection() {
  return `
    <div class="config-block">
      <div class="form-group">
        <label class="form-label">ASN</label>
        <input type="text" name="bgp_asn" class="form-input" style="max-width: 200px;" placeholder="65001">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Neighbor IP</label>
          <input type="text" name="bgp_neighbor[]" class="form-input" placeholder="10.0.0.2">
        </div>
        <div class="form-group">
          <label class="form-label">Remote ASN</label>
          <input type="text" name="bgp_remote_as[]" class="form-input" placeholder="65002">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Address Family</label>
          <input type="text" name="bgp_address_family[]" class="form-input" placeholder="ipv4">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Advertised Network</label>
          <input type="text" name="bgp_network[]" class="form-input" placeholder="10.0.0.0">
        </div>
        <div class="form-group">
          <label class="form-label">Subnet Mask</label>
          <input type="text" name="bgp_mask[]" class="form-input" placeholder="255.255.255.0">
        </div>
      </div>
      <div class="checkbox-group">
        <label class="form-check">
          <input type="checkbox" name="redistribute_ospf_into_bgp" class="form-check-input">
          <span class="form-check-label">Redistribute OSPF</span>
        </label>
        <label class="form-check">
          <input type="checkbox" name="redistribute_rip_into_bgp" class="form-check-input">
          <span class="form-check-label">Redistribute RIP</span>
        </label>
      </div>
      <button type="button" class="btn btn-danger btn-sm" onclick="removeProtocolConfig(this, 'bgp')">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
        Remove
      </button>
    </div>
  `;
}

function getOspfSection() {
  return `
    <div class="config-block">
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Process ID</label>
          <input type="text" name="ospf_process_id[]" class="form-input" placeholder="1">
        </div>
        <div class="form-group">
          <label class="form-label">Network IP</label>
          <input type="text" name="ospf_network[]" class="form-input" placeholder="10.0.0.0">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Wildcard Mask</label>
          <input type="text" name="ospf_wildcard[]" class="form-input" placeholder="0.0.0.255">
        </div>
        <div class="form-group">
          <label class="form-label">Area</label>
          <input type="text" name="ospf_area[]" class="form-input" placeholder="0">
        </div>
      </div>
      <div class="checkbox-group">
        <label class="form-check">
          <input type="checkbox" name="ospf_redistribute_connected[]" class="form-check-input">
          <span class="form-check-label">Redistribute Connected</span>
        </label>
        <label class="form-check">
          <input type="checkbox" name="ospf_redistribute_bgp[]" class="form-check-input">
          <span class="form-check-label">Redistribute BGP</span>
        </label>
      </div>
      <button type="button" class="btn btn-danger btn-sm" onclick="removeProtocolConfig(this, 'ospf')">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
        Remove
      </button>
    </div>
  `;
}

function getEigrpBlock() {
  return `
    <div class="config-block">
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">AS Number</label>
          <input type="text" name="eigrp_as[]" class="form-input" placeholder="100">
        </div>
        <div class="form-group">
          <label class="form-label">Network</label>
          <input type="text" name="eigrp_network[]" class="form-input" placeholder="10.0.0.0">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Wildcard Mask</label>
          <input type="text" name="eigrp_wildcard[]" class="form-input" placeholder="0.0.0.255">
        </div>
      </div>
      <button type="button" class="btn btn-danger btn-sm" onclick="removeProtocolConfig(this, 'eigrp')">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
        Remove
      </button>
    </div>
  `;
}

function getRipBlock() {
  return `
    <div class="config-block">
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">RIP Version</label>
          <input type="text" name="rip_version[]" class="form-input" placeholder="2">
        </div>
        <div class="form-group">
          <label class="form-label">Network IP</label>
          <input type="text" name="rip_network[]" class="form-input" placeholder="10.0.0.0">
        </div>
      </div>
      <button type="button" class="btn btn-danger btn-sm" onclick="removeProtocolConfig(this, 'rip')">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
        Remove
      </button>
    </div>
  `;
}

function getIsisBlock() {
  return `
    <div class="config-block">
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Process Tag</label>
          <input type="text" name="isis_tag[]" class="form-input" placeholder="1">
        </div>
        <div class="form-group">
          <label class="form-label">NET Address</label>
          <input type="text" name="isis_net[]" class="form-input" placeholder="49.0001.0000.0000.0001.00">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Level</label>
          <select name="isis_level[]" class="form-select">
            <option value="level-1">Level 1</option>
            <option value="level-2">Level 2</option>
            <option value="level-1-2">Level 1-2</option>
          </select>
        </div>
      </div>
      <button type="button" class="btn btn-danger btn-sm" onclick="removeProtocolConfig(this, 'isis')">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
        Remove
      </button>
    </div>
  `;
}

function getStpBlock() {
  return `
    <div class="config-block">
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">STP Mode</label>
          <select name="stp_mode[]" class="form-select">
            <option value="pvst">PVST</option>
            <option value="rapid-pvst">Rapid PVST</option>
            <option value="mst">MST</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Priority</label>
          <input type="text" name="stp_priority[]" class="form-input" placeholder="32768">
        </div>
      </div>
      <button type="button" class="btn btn-danger btn-sm" onclick="removeProtocolConfig(this, 'stp')">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
        Remove
      </button>
    </div>
  `;
}

function getVxlanBlock() {
  return `
    <div class="config-block">
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">VNI</label>
          <input type="text" name="vxlan_vni[]" class="form-input" placeholder="10100">
        </div>
        <div class="form-group">
          <label class="form-label">VLAN</label>
          <input type="text" name="vxlan_vlan[]" class="form-input" placeholder="100">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Source Interface</label>
          <input type="text" name="vxlan_source[]" class="form-input" placeholder="Loopback0">
        </div>
        <div class="form-group">
          <label class="form-label">Multicast Group</label>
          <input type="text" name="vxlan_mcast[]" class="form-input" placeholder="239.1.1.1">
        </div>
      </div>
      <button type="button" class="btn btn-danger btn-sm" onclick="removeProtocolConfig(this, 'vxlan')">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
        Remove
      </button>
    </div>
  `;
}

function getMplsBlock() {
  return `
    <div class="config-block">
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">LDP Router ID</label>
          <input type="text" name="mpls_router_id[]" class="form-input" placeholder="1.1.1.1">
        </div>
        <div class="form-group">
          <label class="form-label">Interface</label>
          <input type="text" name="mpls_interface[]" class="form-input" placeholder="GigabitEthernet0/0">
        </div>
      </div>
      <div class="checkbox-group">
        <label class="form-check">
          <input type="checkbox" name="mpls_ldp[]" class="form-check-input">
          <span class="form-check-label">Enable LDP</span>
        </label>
        <label class="form-check">
          <input type="checkbox" name="mpls_te[]" class="form-check-input">
          <span class="form-check-label">Enable Traffic Engineering</span>
        </label>
      </div>
      <button type="button" class="btn btn-danger btn-sm" onclick="removeProtocolConfig(this, 'mpls')">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
        Remove
      </button>
    </div>
  `;
}

function getStaticRouteBlock() {
  return `
    <div class="config-block">
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Destination Network</label>
          <input type="text" name="static_network[]" class="form-input" placeholder="192.168.1.0">
        </div>
        <div class="form-group">
          <label class="form-label">Subnet Mask</label>
          <input type="text" name="static_mask[]" class="form-input" placeholder="255.255.255.0">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Next Hop / Exit Interface</label>
          <input type="text" name="static_nexthop[]" class="form-input" placeholder="10.0.0.1">
        </div>
        <div class="form-group">
          <label class="form-label">Administrative Distance</label>
          <input type="text" name="static_ad[]" class="form-input" placeholder="1" style="max-width: 120px;">
        </div>
      </div>
      <button type="button" class="btn btn-danger btn-sm" onclick="removeProtocolConfig(this, 'static')">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
        Remove
      </button>
    </div>
  `;
}

function showLoading() {
  document.getElementById("loading-overlay").style.display = "flex";
  rotateTerms();
  return true;
}

const terms = [
  "Routing BGP packets to destination...",
  "Configuring Layer 3 protocols...",
  "Injecting routes into routing table...",
  "Initializing OSPF process...",
  "Building VLAN database...",
  "Applying router configuration...",
  "Writing configs to flash memory...",
  "Converging network topology...",
  "Establishing BGP neighbor relationships...",
  "Calculating OSPF shortest paths...",
  "Propagating routing updates...",
  "Configuring interface parameters...",
];

let index = 0;
let rotateInterval;

function rotateTerms() {
  const el = document.getElementById("loading-text");
  el.style.opacity = 0;
  setTimeout(() => {
    el.innerText = terms[index];
    el.style.opacity = 1;
    index = (index + 1) % terms.length;
  }, 500);

  if (!rotateInterval) {
    rotateInterval = setInterval(rotateTerms, 7000);
  }
}

terms.sort(() => Math.random() - 0.5);

async function pushConfig() {
  const deviceId = document.querySelector("select[name='device_id']").value;
  const response = await fetch("/push-config", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ device_id: deviceId }),
  });

  const result = await response.json();
  const messageContainer = document.getElementById("push-message");
  const pushWrapper = document.getElementById("push-button-wrapper");

  if (result.status === "success") {
    messageContainer.innerHTML = `
      <div class="alert alert-success">
        <span class="alert-icon">&#10003;</span>
        <div class="alert-content">Configuration pushed successfully.</div>
      </div>
    `;

    if (pushWrapper) {
      pushWrapper.style.display = "none";
    }

    document.getElementById("config-form").reset();
  } else {
    messageContainer.innerHTML = `
      <div class="alert alert-error">
        <span class="alert-icon">&#10007;</span>
        <div class="alert-content">Push failed: ${result.message}</div>
      </div>
    `;
  }
}
</script>
{% endblock %}
