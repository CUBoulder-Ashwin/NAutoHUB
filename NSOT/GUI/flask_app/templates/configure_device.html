{% extends "base.html" %}
{% block content %}

<h2 class="page-title themed-heading">Configure Device</h2>

<div class="tile-container">
    <form method="POST" class="form-container" id="config-form">
        <div class="form-group">
            <label class="form-label">Device Name:</label>
            <input type="text" name="device_id" class="form-input medium-input" required>
        </div>

        <div class="form-group">
            <label class="form-label">Device Vendor:</label>
            <select name="device_vendor" class="form-input" required>
                <option value="">Select Vendor</option>
                <option value="cisco">Cisco</option>
                <option value="arista">Arista</option>
                <option value="juniper">Juniper</option>
            </select>
        </div>

        <!-- Your router sections go here -->
        <div id="router-sections"></div>

        <div class="form-group text-center button-group">
            <button type="submit" class="form-button csv-button">Generate Configuration</button>
        </div>
    </form>

    <!-- Push Button (hidden until Jenkins success) -->
    <div class="form-group text-center button-group" id="push-button-wrapper" style="display: none;">
        <button type="button" class="form-button csv-button" onclick="pushConfig()">Push Configuration</button>
    </div>

    <!-- LOADING OVERLAY -->
    <div id="loading-overlay" style="display:none;">
        <div class="loading-spinner"></div>
        <p class="loading-text" id="loading-text">Generating YAML...</p>
    </div>
</div>

<script>
    const terms = [
    "Routing BGP packets to Valhalla...",
    "Spinning up Layer 3 magic...",
    "Injecting routes into the Matrix...",
    "Summoning OSPF daemons... ",
    "Crafting VLAN potions...",
    "Talking to network oracles...",
    "Negotiating with DHCP spirits...",
    "Sniffing packets from the astral plane...",
    "Tunneling through hyperspace...",
    "Enabling port-channel wizardry...",
    "Building bridges with STP spells...",
    "Balancing traffic on the tightrope of ECMP...",
    "Fragmenting datagrams with care...",
    "Conjuring MAC addresses...",
    "Programming the P4 gods...",
    "Pinging the void... ",
    "Announcing routes like a prophet...",
    "Weaving MPLS labels into destiny...",
    "Encoding bits of truth...",
    "Assembling TCP handshakes...",
    "Peering with interdimensional routers...",
    "Binding interfaces with eldritch configs...",
    "Casting 'show run' scrolls... ",
    "Parsing YANGs of destiny...",
    "Bridging subnets across galaxies...",
    "Extracting SNMP secrets from the vault...",
    "Interfacing with quantum NICs...",
    "Configuring routers with dark magic...",
    "Recabling cables with thoughts alone...",
    "Blessing interfaces with zero drops...",
    "Summoning Ceos spirits from the cloud... ",
    "Resurrecting containers from the abyss...",
    "Defragmenting reality into packets...",
    "Rebooting layer zero... ",
    "Beaming bits through wormholes...",
    "Unrolling IPv6 prophecies...",
    "Hacking the mainframe of the underlay...",
    "Teleporting configs into flash...",
    ];
    phrases.sort(() => Math.random() - 0.5);
    let phraseIndex = 0;
    let phraseInterval = null;
    
    function startPhraseRotation() {
        rotateLoadingText(); // First message instantly
        phraseInterval = setInterval(rotateLoadingText, 5000); // Cycle every 5s
    }
    
    function stopPhraseRotation() {
        clearInterval(phraseInterval);
    }
    
    function rotateLoadingText() {
        const el = document.getElementById("loading-text");
        el.style.opacity = 0;
        setTimeout(() => {
            el.innerText = phrases[phraseIndex];
            el.style.opacity = 1;
            phraseIndex = (phraseIndex + 1) % phrases.length;
        }, 300);
    }
    
    document.getElementById("config-form").addEventListener("submit", async function (e) {
    e.preventDefault();
    const form = e.target;
    const formData = new FormData(form);
    const overlay = document.getElementById("loading-overlay");
    const message = document.getElementById("loading-text");
    const pushWrapper = document.getElementById("push-button-wrapper");

    overlay.style.display = "flex";
    message.textContent = "Generating YAML...";
    startPhraseRotation();

    const response = await fetch("/configure-device", {
        method: "POST",
        body: formData
    });

    const result = await response.text().then(t => t.trim());

    if (result === "jenkins_success") {
        message.textContent = "Running Jenkins Pipeline...";
        setTimeout(() => {
            stopPhraseRotation();
            overlay.style.display = "none";
            pushWrapper.style.display = "flex";
        }, 3000);
    } else {
        message.textContent = "An error occurred. Please check logs.";
        stopPhraseRotation();
        setTimeout(() => {
            overlay.style.display = "none";
            pushWrapper.style.display = "none";
        }, 3000);
    }
});

    
    async function pushConfig() {
        const deviceId = document.querySelector("input[name='device_id']").value;
        const response = await fetch("/push-config", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ device_id: deviceId })
        });
    
        const result = await response.json();
        if (result.status === "success") {
            alert("Configuration pushed successfully!");
        } else {
            alert("Push failed: " + result.message);
        }
    }
    </script>
<style>
.page-title {
    color: #734c24;
    text-align: center;
    font-family: 'Arial Black', sans-serif;
    margin: 20px 0;
}

/* .themed-heading {
    color: var(--dark-accent);
}
body.light-mode .themed-heading {
    color: var(--light-accent);
} */

.tile-container {
    max-width: 700px;
    margin: 30px auto;
    background-color: inherit;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 0 20px rgba(212, 163, 115, 0.25);
}

body.light-mode .tile-container {
    box-shadow: 0 0 20px rgba(139, 94, 60, 0.25);
}

.form-container {
    background-color: inherit;
}

.form-group {
    margin-bottom: 20px;
}

.short-input {
    max-width: 595px;  /* Adjust this value as needed */
}

.medium-input {
    max-width: 675px;  /* Adjust this value as needed */
}

.form-label {
    font-weight: bold;
    display: block;
    margin-bottom: 5px;
    font-size: 14px;
}

.grouped-form {
    border: 1px solid;
    border-radius: 10px;
    padding: 20px;
    margin-top: 30px;
    margin-bottom: 30px;
    transition: box-shadow 0.3s ease;
}

.grouped-form:hover {
    box-shadow: 0 0 10px rgba(255, 255, 255, 0.05);
}

.device-fields {
    padding: 20px;
}

.device-fields > * {
    margin-bottom: 14px;
}

.form-input,
select.form-input {
    width: 100%;
    padding: 10px;
    border-radius: 6px;
    border: 1px solid;
    transition: border-color 0.3s;
    font-size: 14px;
}

.button-group {
    display: flex;
    justify-content: center;
    gap: 15px;
    flex-wrap: wrap;
    margin-top: 15px;
}

.transparent-button {
    background-color: transparent;
    color: inherit;
    font-size: 14px;
    padding: 6px 14px;
    font-weight: bold;
    border: 1px solid;
    border-radius: 6px;
    margin-top: 10px;
    cursor: pointer;
    transition: background-color 0.2s ease, color 0.2s ease;
}

.transparent-button:hover {
    background-color: var(--dark-hover);
    color: #000;
}

body.light-mode .transparent-button:hover {
    background-color: var(--light-hover);
    color: #fff;
}

.form-button.csv-button {
    margin-top: 10px;
    padding: 10px 22px;
    font-size: 16px;
    font-weight: bold;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    transition: background-color 0.3s ease;
}

/* Light Theme */
body.light-mode .form-label,
body.light-mode .grouped-form {
    color: var(--light-accent);
    border-color: var(--light-accent);
}
body.light-mode .form-button.csv-button {
    background-color: var(--light-accent);
    color: #fff;
}
body.light-mode .form-input,
body.light-mode select.form-input {
    background-color: #fff;
    border-color: var(--light-accent);
    color: #2e2e2e;
}

/* Dark Theme */
body.dark-mode .form-label,
body.dark-mode .grouped-form {
    color: var(--dark-accent);
    border-color: var(--dark-accent);
}
body.dark-mode .form-button.csv-button {
    background-color: var(--dark-accent);
    color: #000;
}
body.dark-mode .form-input,
body.dark-mode select.form-input {
    background-color: #0f0f0f;
    border-color: var(--dark-accent);
    color: #f0e6d2;
}
body.dark-mode select.form-input option {
    background-color: #0f0f0f;
    color: #f0e6d2;
}

body.dark-mode .form-input:focus,
body.dark-mode select.form-input:focus {
    outline: none;
    border-color: var(--dark-accent); /* bronze/golden glow */
    box-shadow: 0 0 8px var(--dark-accent);
}
#loading-overlay {
    position: fixed;
    top: 0; left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.8);
    z-index: 9999;
    display: none;
    justify-content: center;
    align-items: center;
    flex-direction: column;
}
.loading-spinner {
    width: 60px;
    height: 60px;
    border: 6px solid #ccc;
    border-top-color: #d4a373;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 20px;
}
@keyframes spin {
    to { transform: rotate(360deg); }
}
.loading-text {
    color: #d4a373;
    font-size: 22px;
    font-family: 'Arial Black', sans-serif;
    font-weight: bold;
    text-align: center;
    transition: opacity 0.5s ease-in-out;
}

</style>

{% endblock %}
