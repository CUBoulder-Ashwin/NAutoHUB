{% extends "base.html" %}
{% block title %}Configure Device - NAutoHUB{% endblock %}

{% block content %}
<div class="page-header">
  <h1 class="page-title">Configure Device</h1>
  <p class="page-description">Configure interfaces, VLANs, and routing protocols</p>
</div>

<div class="card card-elevated" style="max-width: 800px; margin: 0 auto;">
  <div class="card-body">
    <form method="POST" class="form" id="config-form" onsubmit="return showLoading()">
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Device Name</label>
          <select name="device_id" class="form-select" required>
            <option value="" disabled selected>Select Device</option>
            {% for device in devices %}
            <option value="{{ device }}">{{ device }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Device Vendor</label>
          <select name="device_vendor" class="form-select" required>
            <option value="">Select Vendor</option>
            <option value="arista">Arista</option>
            <option value="cisco">Cisco</option>
            <option value="juniper">Juniper</option>
          </select>
        </div>
      </div>

      <div id="router-sections">
        <!-- Interfaces Section -->
        <div class="form-fieldset" id="interface-section">
          <legend class="form-legend">Interfaces</legend>
          <div class="form-subsection"></div>
          <div class="form-actions form-actions-center" style="border: none; padding: 0; margin: 0;">
            <button type="button" class="btn btn-secondary btn-sm" onclick="addInterface('interface-section')">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"/>
                <line x1="5" y1="12" x2="19" y2="12"/>
              </svg>
              Add Interface
            </button>
          </div>
        </div>

        <!-- Subinterfaces Section -->
        <div class="form-fieldset" id="subinterface-section">
          <legend class="form-legend">Subinterfaces</legend>
          <div class="form-subsection"></div>
          <div class="form-actions form-actions-center" style="border: none; padding: 0; margin: 0;">
            <button type="button" class="btn btn-secondary btn-sm" onclick="addSubinterface('subinterface-section')">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"/>
                <line x1="5" y1="12" x2="19" y2="12"/>
              </svg>
              Add Subinterface
            </button>
          </div>
        </div>

        <!-- VLAN Section -->
        <div class="form-fieldset" id="vlan-section">
          <legend class="form-legend">VLAN Configuration</legend>
          <div class="form-subsection"></div>
          <div class="form-actions form-actions-center" style="border: none; padding: 0; margin: 0;">
            <button type="button" class="btn btn-secondary btn-sm" onclick="addVlan('vlan-section')">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"/>
                <line x1="5" y1="12" x2="19" y2="12"/>
              </svg>
              Add VLAN
            </button>
          </div>
        </div>

        <!-- RIP Section -->
        <div class="form-fieldset" id="rip-section">
          <legend class="form-legend">RIP Configuration</legend>
          <div class="form-subsection"></div>
          <div class="form-actions form-actions-center" style="border: none; padding: 0; margin: 0;">
            <button type="button" class="btn btn-secondary btn-sm" onclick="addRip('rip-section')">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"/>
                <line x1="5" y1="12" x2="19" y2="12"/>
              </svg>
              Add RIP Network
            </button>
          </div>
        </div>

        <!-- OSPF Section -->
        <div class="form-fieldset" id="ospf-section">
          <legend class="form-legend">OSPF Configuration</legend>
          <div class="form-subsection"></div>

          <div class="checkbox-group">
            <label class="form-check">
              <input type="checkbox" name="ospf_redistribute_connected[]" class="form-check-input">
              <span class="form-check-label">Redistribute Connected</span>
            </label>
            <label class="form-check">
              <input type="checkbox" name="ospf_redistribute_bgp[]" class="form-check-input">
              <span class="form-check-label">Redistribute BGP</span>
            </label>
          </div>

          <div class="form-actions form-actions-center" style="border: none; padding: 0; margin: 0;">
            <button type="button" class="btn btn-secondary btn-sm" onclick="addOspf('ospf-section')">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"/>
                <line x1="5" y1="12" x2="19" y2="12"/>
              </svg>
              Add OSPF Network
            </button>
          </div>
        </div>

        <!-- BGP Section -->
        <div class="form-fieldset" id="bgp-section">
          <legend class="form-legend">BGP Configuration</legend>

          <div class="form-group">
            <label class="form-label">ASN</label>
            <input type="text" name="bgp_asn" class="form-input" style="max-width: 200px;">
          </div>

          <div class="form-subsection"></div>

          <div class="checkbox-group">
            <label class="form-check">
              <input type="checkbox" name="redistribute_ospf_into_bgp" class="form-check-input">
              <span class="form-check-label">Redistribute OSPF into BGP</span>
            </label>
            <label class="form-check">
              <input type="checkbox" name="redistribute_rip_into_bgp" class="form-check-input">
              <span class="form-check-label">Redistribute RIP into BGP</span>
            </label>
          </div>

          <div class="form-actions form-actions-center" style="border: none; padding: 0; margin: 0;">
            <button type="button" class="btn btn-secondary btn-sm" onclick="addBgp('bgp-section')">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"/>
                <line x1="5" y1="12" x2="19" y2="12"/>
              </svg>
              Add BGP Neighbor
            </button>
          </div>
        </div>
      </div>

      {% if message %}
      <div class="alert alert-success">
        <span class="alert-icon">&#10003;</span>
        <div class="alert-content">{{ message }}</div>
      </div>
      {% endif %}

      <div id="push-message"></div>

      <div class="form-actions form-actions-center">
        <button type="submit" class="btn btn-primary">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="3"/>
            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
          </svg>
          Generate Configuration
        </button>
      </div>
    </form>

    {% if jenkins_result == 'jenkins_success' %}
    <div class="form-actions form-actions-center" id="push-button-wrapper" style="margin-top: var(--space-4); border: none;">
      <button type="button" class="btn btn-primary" onclick="pushConfig()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M22 2L11 13"/>
          <path d="M22 2L15 22 11 13 2 9 22 2z"/>
        </svg>
        Push Configuration
      </button>
    </div>
    {% endif %}
  </div>
</div>

<!-- Loading Overlay -->
<div class="modal-overlay" id="loading-overlay" style="display: none;">
  <div class="loading-container">
    <div class="loading-spinner"></div>
    <p class="loading-text" id="loading-text">Initializing...</p>
  </div>
</div>

<style>
/* Loading overlay specific styles */
.loading-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: var(--space-4);
}

.loading-spinner {
  width: 48px;
  height: 48px;
  border: 4px solid var(--color-border);
  border-top-color: var(--color-primary);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.loading-text {
  color: var(--color-text-primary);
  font-size: var(--font-size-sm);
  font-weight: var(--font-weight-medium);
  transition: opacity 0.5s ease-in-out;
}

/* Checkbox group styling */
.checkbox-group {
  display: flex;
  flex-wrap: wrap;
  gap: var(--space-4);
  margin: var(--space-4) 0;
}

/* Dynamic config block styling */
.config-block {
  background-color: var(--color-bg-secondary);
  border-radius: var(--radius-md);
  padding: var(--space-4);
  margin-bottom: var(--space-4);
}

.config-block .form-row {
  margin-bottom: var(--space-3);
}

.config-block .form-row:last-child {
  margin-bottom: 0;
}
</style>

<script>
function showLoading() {
  document.getElementById("loading-overlay").style.display = "flex";
  rotateTerms();
  return true;
}

const terms = [
  "Routing BGP packets to Valhalla...",
  "Spinning up Layer 3 magic...",
  "Injecting routes into the Matrix...",
  "Summoning OSPF daemons...",
  "Crafting VLAN potions...",
  "Talking to network oracles...",
  "Negotiating with DHCP spirits...",
  "Sniffing packets from the astral plane...",
  "Tunneling through hyperspace...",
  "Enabling port-channel wizardry...",
  "Building bridges with STP spells...",
  "Balancing traffic on the tightrope of ECMP...",
  "Fragmenting datagrams with care...",
  "Conjuring MAC addresses...",
  "Programming the P4 gods...",
  "Pinging the void...",
  "Announcing routes like a prophet...",
  "Weaving MPLS labels into destiny...",
  "Encoding bits of truth...",
  "Assembling TCP handshakes...",
  "Peering with interdimensional routers...",
  "Binding interfaces with eldritch configs...",
  "Casting 'show run' scrolls...",
  "Parsing YANGs of destiny...",
  "Bridging subnets across galaxies...",
  "Extracting SNMP secrets from the vault...",
  "Interfacing with quantum NICs...",
  "Configuring routers with dark magic...",
  "Recabling cables with thoughts alone...",
  "Blessing interfaces with zero drops...",
  "Summoning Ceos spirits from the cloud...",
  "Resurrecting containers from the abyss...",
  "Defragmenting reality into packets...",
  "Rebooting layer zero...",
  "Beaming bits through wormholes...",
  "Unrolling IPv6 prophecies...",
  "Hacking the mainframe of the underlay...",
  "Teleporting configs into flash...",
];

let index = 0;
let rotateInterval;

function rotateTerms() {
  const el = document.getElementById("loading-text");
  el.style.opacity = 0;
  setTimeout(() => {
    el.innerText = terms[index];
    el.style.opacity = 1;
    index = (index + 1) % terms.length;
  }, 500);

  if (!rotateInterval) {
    rotateInterval = setInterval(rotateTerms, 7000);
  }
}

terms.sort(() => Math.random() - 0.5);

function getInterfaceBlock() {
  return `
    <div class="config-block">
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Interface Type</label>
          <input type="text" name="interface_type[]" class="form-input" placeholder="Ethernet">
        </div>
        <div class="form-group">
          <label class="form-label">Interface Number</label>
          <input type="text" name="interface_number[]" class="form-input" placeholder="1">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">IP Address</label>
          <input type="text" name="interface_ip[]" class="form-input" placeholder="10.0.0.1">
        </div>
        <div class="form-group">
          <label class="form-label">Subnet Mask</label>
          <input type="text" name="interface_mask[]" class="form-input" placeholder="255.255.255.0">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group" style="max-width: 200px;">
          <label class="form-label">Switchport</label>
          <select name="switchport[]" class="form-select">
            <option value="no">No</option>
            <option value="yes">Yes</option>
          </select>
        </div>
      </div>
      <button type="button" class="btn btn-danger btn-sm" onclick="this.closest('.config-block').remove()">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
        Remove
      </button>
    </div>
  `;
}

function getSubinterfaceBlock() {
  return `
    <div class="config-block">
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Parent Interface</label>
          <input type="text" name="subinterface_parent[]" class="form-input" placeholder="Ethernet1">
        </div>
        <div class="form-group">
          <label class="form-label">Subinterface ID</label>
          <input type="text" name="subinterface_id[]" class="form-input" placeholder="100">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Encapsulation VLAN</label>
          <input type="text" name="subinterface_vlan[]" class="form-input" placeholder="100">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">IP Address</label>
          <input type="text" name="subinterface_ip[]" class="form-input" placeholder="10.0.1.1">
        </div>
        <div class="form-group">
          <label class="form-label">Subnet Mask</label>
          <input type="text" name="subinterface_mask[]" class="form-input" placeholder="255.255.255.0">
        </div>
      </div>
      <button type="button" class="btn btn-danger btn-sm" onclick="this.closest('.config-block').remove()">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
        Remove
      </button>
    </div>
  `;
}

function getVlanBlock() {
  return `
    <div class="config-block">
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">VLAN ID</label>
          <input type="text" name="vlan_id[]" class="form-input" placeholder="100">
        </div>
        <div class="form-group">
          <label class="form-label">VLAN Name</label>
          <input type="text" name="vlan_name[]" class="form-input" placeholder="Management">
        </div>
      </div>
      <button type="button" class="btn btn-danger btn-sm" onclick="this.closest('.config-block').remove()">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
        Remove
      </button>
    </div>
  `;
}

function getRipBlock() {
  return `
    <div class="config-block">
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">RIP Version</label>
          <input type="text" name="rip_version[]" class="form-input" placeholder="2">
        </div>
        <div class="form-group">
          <label class="form-label">Network IP</label>
          <input type="text" name="rip_network[]" class="form-input" placeholder="10.0.0.0">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Redistribute BGP ASN</label>
          <input type="text" name="rip_bgp_as[]" class="form-input" placeholder="65001">
        </div>
        <div class="form-group">
          <label class="form-label">Metric</label>
          <input type="text" name="rip_bgp_metric[]" class="form-input" placeholder="1">
        </div>
      </div>
      <label class="form-check">
        <input type="checkbox" name="rip_redistribute" class="form-check-input">
        <span class="form-check-label">Redistribute</span>
      </label>
      <button type="button" class="btn btn-danger btn-sm" onclick="this.closest('.config-block').remove()" style="margin-top: var(--space-3);">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
        Remove
      </button>
    </div>
  `;
}

function getOspfBlock() {
  return `
    <div class="config-block">
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Process ID</label>
          <input type="text" name="ospf_process_id[]" class="form-input" placeholder="1">
        </div>
        <div class="form-group">
          <label class="form-label">Network IP</label>
          <input type="text" name="ospf_network[]" class="form-input" placeholder="10.0.0.0">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Wildcard Mask</label>
          <input type="text" name="ospf_wildcard[]" class="form-input" placeholder="0.0.0.255">
        </div>
        <div class="form-group">
          <label class="form-label">Area</label>
          <input type="text" name="ospf_area[]" class="form-input" placeholder="0">
        </div>
      </div>
      <button type="button" class="btn btn-danger btn-sm" onclick="this.closest('.config-block').remove()">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
        Remove
      </button>
    </div>
  `;
}

function getBgpBlock() {
  return `
    <div class="config-block">
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Neighbor IP</label>
          <input type="text" name="bgp_neighbor[]" class="form-input" placeholder="10.0.0.2">
        </div>
        <div class="form-group">
          <label class="form-label">Remote ASN</label>
          <input type="text" name="bgp_remote_as[]" class="form-input" placeholder="65002">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Address Family</label>
          <input type="text" name="bgp_address_family[]" class="form-input" placeholder="ipv4">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Advertised Network</label>
          <input type="text" name="bgp_network[]" class="form-input" placeholder="10.0.0.0">
        </div>
        <div class="form-group">
          <label class="form-label">Subnet Mask</label>
          <input type="text" name="bgp_mask[]" class="form-input" placeholder="255.255.255.0">
        </div>
      </div>
      <button type="button" class="btn btn-danger btn-sm" onclick="this.closest('.config-block').remove()">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
        Remove
      </button>
    </div>
  `;
}

function addInterface(sectionId) {
  document.querySelector(`#${sectionId} .form-subsection`).insertAdjacentHTML('beforeend', getInterfaceBlock());
}

function addSubinterface(sectionId) {
  document.querySelector(`#${sectionId} .form-subsection`).insertAdjacentHTML('beforeend', getSubinterfaceBlock());
}

function addVlan(sectionId) {
  document.querySelector(`#${sectionId} .form-subsection`).insertAdjacentHTML('beforeend', getVlanBlock());
}

function addRip(sectionId) {
  document.querySelector(`#${sectionId} .form-subsection`).insertAdjacentHTML('beforeend', getRipBlock());
}

function addOspf(sectionId) {
  document.querySelector(`#${sectionId} .form-subsection`).insertAdjacentHTML('beforeend', getOspfBlock());
}

function addBgp(sectionId) {
  document.querySelector(`#${sectionId} .form-subsection`).insertAdjacentHTML('beforeend', getBgpBlock());
}

async function pushConfig() {
  const deviceId = document.querySelector("select[name='device_id']").value;
  const response = await fetch("/push-config", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ device_id: deviceId }),
  });

  const result = await response.json();
  const messageContainer = document.getElementById("push-message");
  const pushWrapper = document.getElementById("push-button-wrapper");

  if (result.status === "success") {
    messageContainer.innerHTML = `
      <div class="alert alert-success">
        <span class="alert-icon">&#10003;</span>
        <div class="alert-content">Configuration pushed successfully.</div>
      </div>
    `;

    if (pushWrapper) {
      pushWrapper.style.display = "none";
    }

    document.getElementById("config-form").reset();
    document.querySelectorAll(".form-subsection").forEach(section => section.innerHTML = "");
  } else {
    messageContainer.innerHTML = `
      <div class="alert alert-error">
        <span class="alert-icon">&#10007;</span>
        <div class="alert-content">Push failed: ${result.message}</div>
      </div>
    `;
  }
}
</script>
{% endblock %}
