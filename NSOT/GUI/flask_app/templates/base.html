<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>{% block title %}NAutoHUB{% endblock %}</title>

  <!-- Prevent FOUC: Apply theme immediately before any rendering -->
  <script>
    (function() {
      const savedTheme = localStorage.getItem('theme') || 'light';
      document.documentElement.setAttribute('data-theme', savedTheme);
    })();
  </script>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

  <!-- Main CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">

  {% block head %}{% endblock %}
</head>

<body>
  <!-- Navbar -->
  <nav class="navbar">
    <div class="navbar-left">
      {% if request.endpoint != 'homepage' %}
        <a href="{{ url_for('homepage') }}" class="navbar-back" title="Back to Home">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
          </svg>
        </a>
      {% endif %}
      <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()" title="Toggle theme">
        <span id="themeIcon">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="5"/>
            <line x1="12" y1="1" x2="12" y2="3"/>
            <line x1="12" y1="21" x2="12" y2="23"/>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
            <line x1="1" y1="12" x2="3" y2="12"/>
            <line x1="21" y1="12" x2="23" y2="12"/>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
          </svg>
        </span>
      </button>
    </div>

    <div class="navbar-center">
      <a href="{{ url_for('homepage') }}" class="navbar-logo">
        <span class="navbar-logo-icon">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="2" y="2" width="20" height="8" rx="2" ry="2"/>
            <rect x="2" y="14" width="20" height="8" rx="2" ry="2"/>
            <line x1="6" y1="6" x2="6.01" y2="6"/>
            <line x1="6" y1="18" x2="6.01" y2="18"/>
          </svg>
          NAutoHUB
        </span>
      </a>
    </div>

    <div class="navbar-right">
      <div class="status-indicator" id="clabStatus" title="Checking status...">
        <span class="status-dot neutral" id="statusDot"></span>
        <span id="statusText">Clab</span>
      </div>
      <button class="navbar-menu-btn" onclick="toggleSideMenu()" title="Menu">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="3" y1="12" x2="21" y2="12"/>
          <line x1="3" y1="6" x2="21" y2="6"/>
          <line x1="3" y1="18" x2="21" y2="18"/>
        </svg>
      </button>
    </div>
  </nav>

  <!-- Side Menu -->
  <div class="menu-overlay" id="menuOverlay" onclick="toggleSideMenu()"></div>
  <aside class="side-menu" id="sideMenu">
    <div class="side-menu-header">
      <span class="side-menu-title">Navigation</span>
      <button class="side-menu-close" onclick="toggleSideMenu()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>
    <div class="side-menu-content">
      <div class="side-menu-section">
        <span class="side-menu-section-title">Build</span>
      </div>
      <nav class="side-menu-nav">
        <a href="{{ url_for('add_hosts') }}" class="side-menu-link">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
            <circle cx="8.5" cy="7" r="4"/>
            <line x1="20" y1="8" x2="20" y2="14"/>
            <line x1="23" y1="11" x2="17" y2="11"/>
          </svg>
          Add Hosts
        </a>
        <a href="{{ url_for('build_topology') }}" class="side-menu-link">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polygon points="12 2 2 7 12 12 22 7 12 2"/>
            <polyline points="2 17 12 22 22 17"/>
            <polyline points="2 12 12 17 22 12"/>
          </svg>
          Build Topology
        </a>
      </nav>

      <div class="side-menu-section">
        <span class="side-menu-section-title">Configure</span>
      </div>
      <nav class="side-menu-nav">
        <a href="{{ url_for('add_device') }}" class="side-menu-link">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="4" y="4" width="16" height="16" rx="2" ry="2"/>
            <line x1="12" y1="8" x2="12" y2="16"/>
            <line x1="8" y1="12" x2="16" y2="12"/>
          </svg>
          Add Device
        </a>
        <a href="{{ url_for('configure_device') }}" class="side-menu-link">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="3"/>
            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
          </svg>
          Configure Device
        </a>
      </nav>

      <div class="side-menu-section">
        <span class="side-menu-section-title">Manage</span>
      </div>
      <nav class="side-menu-nav">
        <a href="{{ url_for('tools') }}" class="side-menu-link">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
          </svg>
          Tools
        </a>
        <a href="{{ url_for('ipam') }}" class="side-menu-link">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <ellipse cx="12" cy="5" rx="9" ry="3"/>
            <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/>
            <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/>
          </svg>
          IPAM
        </a>
      </nav>

      <div class="side-menu-section">
        <span class="side-menu-section-title">Monitor</span>
      </div>
      <nav class="side-menu-nav">
        <a href="{{ url_for('dashboard') }}" class="side-menu-link">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="3" width="7" height="7"/>
            <rect x="14" y="3" width="7" height="7"/>
            <rect x="14" y="14" width="7" height="7"/>
            <rect x="3" y="14" width="7" height="7"/>
          </svg>
          Dashboard
        </a>
        <a href="{{ url_for('topology') }}" class="side-menu-link">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="18" cy="18" r="3"/>
            <circle cx="6" cy="6" r="3"/>
            <path d="M13 6h3a2 2 0 0 1 2 2v7"/>
            <line x1="6" y1="9" x2="6" y2="21"/>
          </svg>
          Topology
        </a>
      </nav>

      <div class="side-menu-section">
        <span class="side-menu-section-title">Help</span>
      </div>
      <nav class="side-menu-nav">
        <a href="{{ url_for('about') }}" class="side-menu-link">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"/>
            <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
            <line x1="12" y1="17" x2="12.01" y2="17"/>
          </svg>
          About
        </a>
        <a href="{{ url_for('contact') }}" class="side-menu-link">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
            <polyline points="22,6 12,13 2,6"/>
          </svg>
          Contact
        </a>
      </nav>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="container">
    {% block content %}{% endblock %}
  </main>

  <!-- Chatbot Toggle -->
  <button class="chat-toggle" id="chatToggle" onclick="toggleChatbot()" title="AI Assistant">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
    </svg>
  </button>

  <!-- Chatbot Container -->
  <div class="chat-container" id="chatContainer">
    <div class="chat-header">
      <div class="chat-header-title">
        <div class="chat-header-icon">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <path d="M8 14s1.5 2 4 2 4-2 4-2"/>
            <line x1="9" y1="9" x2="9.01" y2="9"/>
            <line x1="15" y1="9" x2="15.01" y2="9"/>
          </svg>
        </div>
        <span class="chat-header-text">NAHUB Assistant</span>
      </div>
      <div class="chat-header-actions">
        <button class="chat-header-btn" onclick="expandChatbot()" title="Expand">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="15 3 21 3 21 9"/>
            <polyline points="9 21 3 21 3 15"/>
            <line x1="21" y1="3" x2="14" y2="10"/>
            <line x1="3" y1="21" x2="10" y2="14"/>
          </svg>
        </button>
        <button class="chat-header-btn" onclick="closeChatbot()" title="Close">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>
    </div>
    <div class="chat-messages" id="chatMessages"></div>
    <div class="chat-input">
      <input type="text" class="chat-input-field" id="chatInput" placeholder="Ask me anything..." onkeypress="handleChatKeypress(event)">
      <button class="chat-send-btn" id="chatSendBtn" onclick="sendChatMessage()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="22" y1="2" x2="11" y2="13"/>
          <polygon points="22 2 15 22 11 13 2 9 22 2"/>
        </svg>
      </button>
    </div>
  </div>

  <script>
    // ========== Theme Management ==========
    function toggleTheme() {
      const html = document.documentElement;
      const currentTheme = html.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

      html.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      updateThemeIcon(newTheme);
    }

    function updateThemeIcon(theme) {
      const icon = document.getElementById('themeIcon');
      if (theme === 'dark') {
        icon.innerHTML = `
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
          </svg>
        `;
      } else {
        icon.innerHTML = `
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="5"/>
            <line x1="12" y1="1" x2="12" y2="3"/>
            <line x1="12" y1="21" x2="12" y2="23"/>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
            <line x1="1" y1="12" x2="3" y2="12"/>
            <line x1="21" y1="12" x2="23" y2="12"/>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
          </svg>
        `;
      }
    }

    // ========== Side Menu ==========
    function toggleSideMenu() {
      const menu = document.getElementById('sideMenu');
      const overlay = document.getElementById('menuOverlay');
      menu.classList.toggle('open');
      overlay.classList.toggle('visible');
    }

    // ========== Clab Status ==========
    function updateClabStatus() {
      const dot = document.getElementById('statusDot');
      const text = document.getElementById('statusText');

      fetch('/clab-health')
        .then(response => response.json())
        .then(data => {
          dot.className = 'status-dot';
          if (data.status === 'up') {
            dot.classList.add('online');
            text.textContent = 'Online';
          } else {
            dot.classList.add('offline');
            text.textContent = 'Offline';
          }
          document.getElementById('clabStatus').title = data.message || 'Status check complete';
        })
        .catch(() => {
          dot.className = 'status-dot offline';
          text.textContent = 'Error';
        });
    }

    // ========== Chatbot ==========
    let chatHistory = [];

    function toggleChatbot() {
      const container = document.getElementById('chatContainer');
      container.classList.toggle('visible');
      if (container.classList.contains('visible')) {
        document.getElementById('chatInput').focus();
      }
    }

    function closeChatbot() {
      const container = document.getElementById('chatContainer');
      container.classList.remove('visible', 'expanded');
      chatHistory = [];
      document.getElementById('chatMessages').innerHTML = '';
    }

    function expandChatbot() {
      document.getElementById('chatContainer').classList.toggle('expanded');
    }

    function handleChatKeypress(event) {
      if (event.key === 'Enter') {
        sendChatMessage();
      }
    }

    function sendChatMessage() {
      const input = document.getElementById('chatInput');
      const message = input.value.trim();
      if (!message) return;

      const messages = document.getElementById('chatMessages');
      const sendBtn = document.getElementById('chatSendBtn');

      input.value = '';
      input.disabled = true;
      sendBtn.disabled = true;

      // Add user message
      const userDiv = document.createElement('div');
      userDiv.className = 'chat-message chat-message-user';
      userDiv.innerHTML = `
        <span class="chat-message-label">You</span>
        <div class="chat-message-content">${escapeHtml(message)}</div>
      `;
      messages.appendChild(userDiv);

      // Add bot message placeholder
      const botDiv = document.createElement('div');
      botDiv.className = 'chat-message chat-message-bot';
      botDiv.innerHTML = `
        <span class="chat-message-label">Assistant</span>
        <div class="chat-message-content" id="botResponse">
          <div class="chat-typing">
            <span class="chat-typing-dot"></span>
            <span class="chat-typing-dot"></span>
            <span class="chat-typing-dot"></span>
          </div>
        </div>
      `;
      messages.appendChild(botDiv);
      messages.scrollTop = messages.scrollHeight;

      chatHistory.push(`You: ${message}`);

      fetch('/chat-query', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: message, history: chatHistory })
      })
      .then(response => {
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        const botResponseEl = document.getElementById('botResponse');
        botResponseEl.innerHTML = '';
        let fullResponse = '';

        function readChunk() {
          reader.read().then(({ done, value }) => {
            if (done) {
              chatHistory.push(`Bot: ${fullResponse}`);
              input.disabled = false;
              sendBtn.disabled = false;
              input.focus();
              return;
            }

            const chunk = decoder.decode(value, { stream: true });
            fullResponse += chunk;
            botResponseEl.textContent = fullResponse;
            messages.scrollTop = messages.scrollHeight;
            readChunk();
          });
        }
        readChunk();
      })
      .catch(() => {
        document.getElementById('botResponse').textContent = 'Error contacting assistant.';
        input.disabled = false;
        sendBtn.disabled = false;
      });
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ========== Initialize ==========
    window.onload = () => {
      const savedTheme = localStorage.getItem('theme') || 'light';
      document.documentElement.setAttribute('data-theme', savedTheme);
      updateThemeIcon(savedTheme);
      updateClabStatus();
    };

    setInterval(updateClabStatus, 5000);
  </script>

  {% block scripts %}{% endblock %}
</body>
</html>
