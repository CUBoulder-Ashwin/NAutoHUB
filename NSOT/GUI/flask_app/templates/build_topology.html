{% extends "base.html" %}
{% block content %}

<h2 class="page-title">Build Topology</h2>

<div class="tile-container">
  <form method="POST" id="topology-form" class="form-container">
    <div class="form-group">
      <label class="form-label">Topology Name:</label>
      <input type="text" name="topo_name" class="form-input" required>
    </div>

    <div class="form-group">
      <label class="form-label">Number of Devices:</label>
      <input type="number" name="device_count" id="device-count" class="form-input" min="1" required>
    </div>

    <div id="device-form-list"></div>

    <div id="connections-section" style="display: none;">
      <h3 class="page-title" style="margin-top: 40px;">Connect Devices</h3>
      <input type="hidden" name="link_count" id="link-count" value="0">
      <div id="link-forms"></div>
      <div class="button-group">
        <button type="button" class="transparent-button" onclick="addLinkRow()">+  Add Link</button>
      </div>
    </div>
    {% if message %}
      <div class="form-group text-center" style="margin-top: 20px; margin-bottom: 10px;">
        <p class="message-text">
          {{ message|safe }}
        </p>
      </div>
    {% endif %}
    <div class="form-group text-center button-group" style="margin-top: 30px;">
      <button type="submit" class="form-button csv-button">Generate YAML</button>
    </div>
  </form>
</div>

<script>
let dockerImages = {{ docker_images|tojson|safe }};
let kinds = ["linux", "ceos"];
let linkCount = 0;

document.getElementById("device-count").addEventListener("change", function () {
  const count = parseInt(this.value);
  const list = document.getElementById("device-form-list");
  list.innerHTML = "";
  linkCount = 0;
  document.getElementById("link-count").value = 0;
  document.getElementById("connections-section").style.display = count > 0 ? "block" : "none";
  document.getElementById("link-forms").innerHTML = "";

  for (let i = 0; i < count; i++) {
    const form = document.createElement("div");
    form.classList.add("form-group", "grouped-form");
    form.innerHTML = `
      <div class="device-fields">
        <h4 class="device-title" style="margin-bottom: 15px;">Device ${i + 1}</h4>
        <label class="form-label">Name:</label>
        <input type="text" name="device_name_${i}" class="form-input" required>

        <label class="form-label">Kind:</label>
        <select name="device_kind_${i}" class="form-input" required>
          <option value="">-- Select Kind --</option>
          ${kinds.map(k => `<option value="${k}">${k}</option>`).join("")}
        </select>

        <label class="form-label">Docker Image:</label>
        <select name="device_image_${i}" class="form-input" required>
          <option value="">-- Select Image --</option>
          ${dockerImages.map(img => `<option value="${img}">${img}</option>`).join("")}
        </select>

        <label class="form-label">Config File (Optional):</label>
        <input type="text" name="device_config_${i}" class="form-input" placeholder="Leave blank if not needed">

        <label class="form-label">Exec Commands (for linux):</label>
        <textarea name="device_exec_${i}[]" class="form-input" rows="3" placeholder="One command per line"></textarea>
      </div>
    `;
    list.appendChild(form);
  }
});

let linkRows = [];

function addLinkRow() {
  const devices = [...document.querySelectorAll('[name^="device_name_"]')]
  .map((el, idx) => el.value.trim() || `Device_${idx + 1}`);

  if (devices.length < 2) return;

  linkRows.push({ dev1: devices[0], dev2: devices[1] }); // Default to first 2
  renderLinkRows(devices);
}

function removeLinkRow(index) {
  linkRows.splice(index, 1); // Remove row at index
  const devices = [...document.querySelectorAll('[name^="device_name_"]')].map(el => el.value.trim()).filter(Boolean);
  renderLinkRows(devices);
}

function renderLinkRows(devices) {
  const container = document.getElementById("link-forms");
  container.innerHTML = "";
  document.getElementById("link-count").value = linkRows.length;

  linkRows.forEach((link, i) => {
    const row = document.createElement("div");
    row.classList.add("form-group", "grouped-form");
    row.innerHTML = `
      <div class="device-fields">
        <label class="form-label">Link ${i + 1}</label>
        <div style="display: flex; gap: 10px; align-items: center;">
          <select name="link_dev1_${i}" class="form-input" required>
            ${devices.map(d => `<option value="${d}" ${d === link.dev1 ? "selected" : ""}>${d}</option>`).join("")}
          </select>
          <span style="font-weight: bold;">â‡„</span>
          <select name="link_dev2_${i}" class="form-input" required>
            ${devices.map(d => `<option value="${d}" ${d === link.dev2 ? "selected" : ""}>${d}</option>`).join("")}
          </select>
        </div>
        <div class="delete-button-wrapper">
          <button type="button" class="transparent-button" onclick="removeLinkRow(${i})">-  Delete Link</button>
        </div>
      </div>
    `;
    container.appendChild(row);
  });
}
</script>

<style>
  /* -- same styles as add_hosts.html -- */
  :root {
    --dark-bg: #0d0d0d;
    --dark-accent: #d4a373;
    --dark-hover: #eec68d;
    --light-bg: #fdf6e3;
    --light-accent: #8b5e3c;
    --light-hover: #b07c59;
  }
  
  .page-title {
    text-align: center;
    color: #734c24;
    font-family: 'Arial Black', sans-serif;
    margin: 20px 0;
  }
  
  .tile-container {
    max-width: 700px;
    margin: 30px auto;
    background-color: inherit;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 0 20px rgba(212, 163, 115, 0.25);
    transition: box-shadow 0.3s ease;
  }
  
  body.light-mode .tile-container {
    box-shadow: 0 0 20px rgba(139, 94, 60, 0.25);
  }
  
  .form-container {
    max-width: 700px;
    margin: 0 auto;
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 0 15px rgba(0,0,0,0.4);
    background-color: inherit;
  }
  
  .form-group {
    margin-bottom: 20px;
  }
  
  .grouped-form {
    border: 1px solid;
    border-radius: 10px;
    padding: 20px;
    margin-top: 30px;
    margin-bottom: 30px;
    position: relative;
    transition: box-shadow 0.3s ease;
  }
  
  .grouped-form:hover {
    box-shadow: 0 0 10px rgba(255,255,255,0.05);
  }
  
  .device-fields {
    padding: 20px 40px 20px 20px;
  }
  
  .device-fields > * {
    margin-bottom: 14px;
  }
  
  .form-input,
  select.form-input,
  textarea.form-input {
    width: 100%;
    padding: 8px 10px;
    border-radius: 6px;
    border: 1px solid;
    background-color: inherit;
    color: inherit;
    transition: border-color 0.3s;
    font-size: 14px;
  }
  
  .form-input:focus,
  select.form-input:focus {
    outline: none;
    box-shadow: 0 0 5px;
  }
  
  .form-label {
    display: block;
    font-weight: bold;
    margin-bottom: 4px;
    font-size: 14px;
  }
  
  .button-group {
    display: flex;
    justify-content: center;
    gap: 15px;
    flex-wrap: wrap;
  }
  
  .transparent-button {
    background-color: transparent;
    color: inherit;
    font-size: 14px;
    padding: 6px 14px;
    font-weight: bold;
    border: 1px solid;
    border-radius: 6px;
    margin-top: 10px;
    cursor: pointer;
    transition: background-color 0.2s ease, color 0.2s ease;
  }
  
  .transparent-button:hover {
    background-color: var(--dark-hover);
    color: #000;
  }
  
  body.light-mode .transparent-button:hover {
    background-color: var(--light-hover);
    color: #fff;
  }
  
  .form-button.csv-button {
    margin-top: 10px;
    padding: 10px 22px;
    font-size: 16px;
    font-weight: bold;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  
  /* body.light-mode .page-title,
  body.light-mode .form-label {
    color: var(--light-accent);
  } */
  body.light-mode .form-container {
    background-color: var(--light-bg);
  }
  body.light-mode .form-input,
  body.light-mode select.form-input {
    border-color: var(--light-accent);
    background-color: #fff;
    color: #2e2e2e;
  }
  body.light-mode .form-button {
    background-color: var(--light-accent);
    color: #fff;
  }
  body.light-mode .form-button:hover {
    background-color: var(--light-hover);
  }
  body.light-mode .grouped-form {
    border-color: var(--light-accent);
  }
  
  /* body.dark-mode .page-title,
  body.dark-mode .form-label {
    color: var(--dark-accent);
  } */
  body.dark-mode .form-container {
    background-color: var(--dark-bg);
  }
  body.dark-mode .form-input,
  body.dark-mode select.form-input {
    border-color: var(--dark-accent);
    background-color: #0f0f0f;
    color: #f0e6d2;
  }
  body.dark-mode .form-button {
    background-color: var(--dark-accent);
    color: #000;
  }
  body.dark-mode .form-button:hover {
    background-color: var(--dark-hover);
  }
  body.dark-mode .grouped-form {
    border-color: var(--dark-accent);
  }
  .message-text {
  font-weight: bold;
  text-align: center;
  color: var(--dark-accent);
  font-size: 16px;
}

body.light-mode .message-text {
  color: var(--light-accent);
}

.message-text code {
  font-family: monospace;
  background-color: transparent;
  color: inherit;
  padding: 2px 4px;
  border-radius: 4px;
  display: inline-block;
}
.device-title {
  font-size: 18px;
  font-weight: bold;
  color: var(--dark-accent);
}

body.light-mode .device-title {
  color: var(--light-accent);
}

  </style>
  
{% endblock %}
