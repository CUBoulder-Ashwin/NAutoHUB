{% extends "base.html" %}
{% block title %}Build Topology - NAutoHUB{% endblock %}

{% block content %}
<div class="page-header">
  <h1 class="page-title">Build Topology</h1>
  <p class="page-description">Create and deploy network topologies with Containerlab</p>
</div>

<div class="card card-elevated" style="max-width: 800px; margin: 0 auto;">
  <div class="card-body">
    <form method="POST" id="topology-form" class="form">
      <div class="form-group">
        <label class="form-label">Topology Name</label>
        <input type="text" name="topo_name" class="form-input" required>
      </div>

      <div id="device-form-list"></div>

      <div class="form-actions form-actions-center" style="border: none; padding: 0; margin: 0;">
        <button type="button" class="btn btn-secondary" onclick="addDeviceRow()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="5" x2="12" y2="19"/>
            <line x1="5" y1="12" x2="19" y2="12"/>
          </svg>
          Add Device
        </button>
      </div>

      <div id="connections-section" style="display: none; margin-top: var(--space-6);">
        <div class="section-header">
          <span class="section-title">Device Links</span>
          <div class="section-line"></div>
        </div>
        <input type="hidden" name="link_count" id="link-count" value="0">
        <div id="link-forms"></div>
        <div class="form-actions form-actions-center" style="border: none; padding: 0; margin: 0;">
          <button type="button" class="btn btn-secondary" onclick="addLinkRow()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="12" y1="5" x2="12" y2="19"/>
              <line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
            Add Link
          </button>
        </div>
      </div>

      {% if message %}
      <div class="alert {% if 'Failed' in message or '❌' in message %}alert-error{% else %}alert-success{% endif %}">
        <span class="alert-icon">{% if 'Failed' in message or '❌' in message %}&#10007;{% else %}&#10003;{% endif %}</span>
        <div class="alert-content">{{ message|safe }}</div>
      </div>
      {% endif %}

      <input type="hidden" name="link_dev1_json" id="link-dev1-json">
      <input type="hidden" name="link_dev2_json" id="link-dev2-json">

      <div class="form-actions form-actions-center">
        <button type="submit" class="btn btn-primary" name="generate">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
            <polyline points="14 2 14 8 20 8"/>
            <line x1="12" y1="18" x2="12" y2="12"/>
            <line x1="9" y1="15" x2="15" y2="15"/>
          </svg>
          Generate YAML
        </button>
      </div>
    </form>

    <div class="form-actions form-actions-center" style="margin-top: var(--space-4); border: none;">
      <form method="POST" action="{{ url_for('deploy_topology_route') }}" style="display: inline;" onsubmit="showLoading()">
        <button type="submit" class="btn btn-primary" formnovalidate>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
          </svg>
          Build Topology
        </button>
      </form>

      <form method="POST" action="{{ url_for('delete_topology_route') }}" style="display: inline;" onsubmit="showLoading()">
        <button type="submit" class="btn btn-danger" formnovalidate>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="3 6 5 6 21 6"/>
            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
            <line x1="10" y1="11" x2="10" y2="17"/>
            <line x1="14" y1="11" x2="14" y2="17"/>
          </svg>
          Delete Topology
        </button>
      </form>
    </div>
  </div>
</div>

<!-- Loading Overlay -->
<div class="modal-overlay" id="loading-overlay" style="display: none;">
  <div class="loading-container">
    <div class="loading-spinner"></div>
    <p class="loading-text" id="loading-text">Initializing...</p>
  </div>
</div>

<style>
/* Loading overlay specific styles */
.loading-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: var(--space-4);
}

.loading-spinner {
  width: 48px;
  height: 48px;
  border: 4px solid var(--color-border);
  border-top-color: var(--color-primary);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.loading-text {
  color: var(--color-text-primary);
  font-size: var(--font-size-sm);
  font-weight: var(--font-weight-medium);
  transition: opacity 0.5s ease-in-out;
}

/* Link row styling */
.link-row-content {
  display: flex;
  gap: var(--space-3);
  align-items: center;
}

.link-arrow {
  font-weight: var(--font-weight-bold);
  color: var(--color-text-muted);
}
</style>

<script>
let dockerImages = {{ docker_images|tojson|safe }};
let kinds = ["ceos", "linux"];
let deviceRows = [];
let linkRows = [];

const terms = [
  "Routing BGP packets to Valhalla...",
  "Spinning up Layer 3 magic...",
  "Injecting routes into the Matrix...",
  "Summoning OSPF daemons...",
  "Crafting VLAN potions...",
  "Talking to network oracles...",
  "Negotiating with DHCP spirits...",
  "Sniffing packets from the astral plane...",
  "Tunneling through hyperspace...",
  "Enabling port-channel wizardry...",
  "Building bridges with STP spells...",
  "Balancing traffic on the tightrope of ECMP...",
  "Fragmenting datagrams with care...",
  "Conjuring MAC addresses...",
  "Programming the P4 gods...",
  "Pinging the void...",
  "Announcing routes like a prophet...",
  "Weaving MPLS labels into destiny...",
  "Encoding bits of truth...",
  "Assembling TCP handshakes...",
  "Peering with interdimensional routers...",
  "Binding interfaces with eldritch configs...",
  "Casting 'show run' scrolls...",
  "Parsing YANGs of destiny...",
  "Bridging subnets across galaxies...",
  "Extracting SNMP secrets from the vault...",
  "Interfacing with quantum NICs...",
  "Configuring routers with dark magic...",
  "Recabling cables with thoughts alone...",
  "Blessing interfaces with zero drops...",
  "Summoning Ceos spirits from the cloud...",
  "Resurrecting containers from the abyss...",
  "Defragmenting reality into packets...",
  "Rebooting layer zero...",
  "Beaming bits through wormholes...",
  "Unrolling IPv6 prophecies...",
  "Hacking the mainframe of the underlay...",
  "Teleporting configs into flash...",
  "Establishing adjacency with the cosmos...",
  "Redistributing routes from alternate dimensions...",
  "Encrypting secrets with quantum keys...",
  "Converging the network state of reality...",
  "Flapping links to confuse evil spirits...",
  "Calculating shortest path to enlightenment...",
  "Draining queues of existential packets...",
  "Gracefully restarting the universe...",
  "Applying ACLs to chaos...",
  "Synchronizing clocks across timelines...",
  "Spawning virtual routers in the ether...",
  "Debugging the fabric of spacetime...",
];
terms.sort(() => Math.random() - 0.5);
let index = 0;
let rotateInterval;

document.addEventListener("DOMContentLoaded", () => {
  renderDeviceForms();
});

function rotateTerms() {
  const el = document.getElementById("loading-text");
  el.style.opacity = 0;
  setTimeout(() => {
    el.innerText = terms[index];
    el.style.opacity = 1;
    index = (index + 1) % terms.length;
  }, 500);
}

function showLoading() {
  const overlay = document.getElementById("loading-overlay");
  overlay.style.display = "flex";
  rotateTerms();
  rotateInterval = setInterval(rotateTerms, 7000);
}

function collectCurrentDeviceData() {
  const updated = [];
  document.querySelectorAll("#device-form-list .form-fieldset").forEach((form, i) => {
    updated.push({
      name: form.querySelector(`[name="device_name_${i}"]`)?.value || "",
      kind: form.querySelector(`[name="device_kind_${i}"]`)?.value || "",
      image: form.querySelector(`[name="device_image_${i}"]`)?.value || "",
      config: form.querySelector(`[name="device_config_${i}"]`)?.value || "",
      exec: form.querySelector(`[name="device_exec_${i}[]"]`)?.value || "",
      mgmt_ip: form.querySelector(`[name="device_mgmt_ip_${i}"]`)?.value || "",
      username: form.querySelector(`[name="device_username_${i}"]`)?.value || "",
      password: form.querySelector(`[name="device_password_${i}"]`)?.value || ""
    });
  });
  return updated;
}

function collectCurrentLinkData() {
  const updated = [];
  document.querySelectorAll("#link-forms .form-fieldset").forEach(form => {
    const selects = form.querySelectorAll("select");
    updated.push({
      dev1: selects[0]?.value || "",
      dev2: selects[1]?.value || ""
    });
  });
  return updated;
}

function addDeviceRow() {
  deviceRows = collectCurrentDeviceData();
  linkRows = collectCurrentLinkData();
  deviceRows.push({});
  renderDeviceForms();
}

function removeDeviceRow(index) {
  deviceRows = collectCurrentDeviceData();
  linkRows = collectCurrentLinkData();
  deviceRows.splice(index, 1);
  renderDeviceForms();
}

function renderDeviceForms() {
  const list = document.getElementById("device-form-list");
  list.innerHTML = "";
  document.getElementById("connections-section").style.display = deviceRows.length > 0 ? "block" : "none";

  deviceRows.forEach((device, i) => {
    const form = document.createElement("div");
    form.classList.add("form-fieldset");
    form.innerHTML = `
      <legend class="form-legend">
        Device ${i + 1}
        <button type="button" class="btn btn-danger btn-sm" onclick="removeDeviceRow(${i})" style="float: right; margin-top: -4px;">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
          Remove
        </button>
      </legend>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Name</label>
          <input type="text" name="device_name_${i}" class="form-input" required value="${device.name || ''}">
        </div>
        <div class="form-group">
          <label class="form-label">Kind</label>
          <select name="device_kind_${i}" class="form-select" required onchange="toggleConfigExec(${i})" id="kind-${i}">
            <option value="">-- Select Kind --</option>
            ${kinds.map(k => `<option value="${k}" ${k === device.kind ? "selected" : ""}>${k}</option>`).join("")}
          </select>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">Docker Image</label>
        <select name="device_image_${i}" class="form-select" required>
          <option value="">-- Select Image --</option>
          ${dockerImages.map(img => `<option value="${img}" ${img === device.image ? "selected" : ""}>${img}</option>`).join("")}
        </select>
      </div>

      <div id="config-section-${i}" class="form-group" style="display: ${device.kind === 'ceos' ? 'block' : 'none'};">
        <label class="form-label">Config File (Optional)</label>
        <input type="text" name="device_config_${i}" class="form-input" value="${device.config || ''}">
      </div>

      <div id="exec-section-${i}" class="form-group" style="display: ${device.kind === 'linux' ? 'block' : 'none'};">
        <label class="form-label">Exec Commands (for linux)</label>
        <textarea name="device_exec_${i}[]" class="form-textarea" rows="3">${device.exec || ''}</textarea>
      </div>

      <div class="form-group">
        <label class="form-label">Management IP Address (with subnet)</label>
        <input type="text" name="device_mgmt_ip_${i}" class="form-input" placeholder="10.0.0.1/24" value="${device.mgmt_ip || ''}">
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label">SSH Username</label>
          <input type="text" name="device_username_${i}" class="form-input" placeholder="admin" value="${device.username || ''}">
        </div>
        <div class="form-group">
          <label class="form-label">SSH Password</label>
          <input type="password" name="device_password_${i}" class="form-input" placeholder="admin" value="${device.password || ''}">
        </div>
      </div>
    `;
    list.appendChild(form);
  });

  for (let i = 0; i < deviceRows.length; i++) toggleConfigExec(i);
  renderLinkRows();
}

function toggleConfigExec(i) {
  const kind = document.getElementById(`kind-${i}`)?.value || "";
  document.getElementById(`config-section-${i}`).style.display = kind === "ceos" ? "block" : "none";
  document.getElementById(`exec-section-${i}`).style.display = kind === "linux" ? "block" : "none";
}

function addLinkRow() {
  deviceRows = collectCurrentDeviceData();
  linkRows = collectCurrentLinkData();
  const updatedLinks = [...linkRows];
  updatedLinks.push({ dev1: "", dev2: "" });
  linkRows = updatedLinks;
  renderLinkRows();
}

function removeLinkRow(index) {
  linkRows.splice(index, 1);
  renderLinkRows();
}

function renderLinkRows() {
  const container = document.getElementById("link-forms");
  container.innerHTML = "";
  document.getElementById("link-count").value = linkRows.length;

  const devices = [...document.querySelectorAll('[name^="device_name_"]')].map(el => el.value.trim()).filter(Boolean);

  linkRows.forEach((link, i) => {
    const row = document.createElement("div");
    row.classList.add("form-fieldset");
    row.innerHTML = `
      <legend class="form-legend">
        Link ${i + 1}
        <button type="button" class="btn btn-danger btn-sm" onclick="removeLinkRow(${i})" style="float: right; margin-top: -4px;">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
          Remove
        </button>
      </legend>
      <div class="link-row-content">
        <div class="form-group" style="flex: 1;">
          <select name="link_dev1_${i}" class="form-select" onchange="updateLinkRow(${i}, 0)">
            <option value="">-- Select Device --</option>
            ${devices.map(d => `<option value="${d}" ${d === link.dev1 ? "selected" : ""}>${d}</option>`).join("")}
          </select>
        </div>
        <span class="link-arrow">&#8644;</span>
        <div class="form-group" style="flex: 1;">
          <select name="link_dev2_${i}" class="form-select" onchange="updateLinkRow(${i}, 1)">
            <option value="">-- Select Device --</option>
            ${devices.map(d => `<option value="${d}" ${d === link.dev2 ? "selected" : ""}>${d}</option>`).join("")}
          </select>
        </div>
      </div>
    `;
    container.appendChild(row);
  });

  syncLinkJSON();
}

function updateLinkRow(index, side) {
  const container = document.getElementById("link-forms");
  const row = container.querySelectorAll(".form-fieldset")[index];
  const selects = row.querySelectorAll("select");

  if (side === 0) {
    linkRows[index].dev1 = selects[0].value;
  } else {
    linkRows[index].dev2 = selects[1].value;
  }

  syncLinkJSON();
}

function syncLinkJSON() {
  const dev1List = [];
  const dev2List = [];
  document.querySelectorAll("#link-forms .form-fieldset").forEach((form, i) => {
    const selects = form.querySelectorAll("select");
    dev1List.push(selects[0]?.value || "");
    dev2List.push(selects[1]?.value || "");
  });
  document.getElementById("link-dev1-json").value = JSON.stringify(dev1List);
  document.getElementById("link-dev2-json").value = JSON.stringify(dev2List);
}
</script>
{% endblock %}
